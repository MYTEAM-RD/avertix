<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avertix - Advanced Multi-Camera Violence Detection</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #4cc9f0;
      --accent: #f72585;
      --dark: #121212;
      --darker: #0a0a0a;
      --card-bg: #1e1e1e;
      --success: #4ade80;
      --danger: #f72585;
      --warning: #fb923c;
      --info: #4cc9f0;
      --text: #ffffff;
      --text-secondary: #b0b0b0;
      --border-color: rgba(255, 255, 255, 0.08);
      --border-radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }

    .light-theme {
      --dark: #f5f5f5;
      --darker: #e0e0e0;
      --card-bg: #ffffff;
      --text: #121212;
      --text-secondary: #555555;
      --border-color: rgba(0, 0, 0, 0.1);
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--dark);
      color: var(--text);
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.3s, color 0.3s;
    }

    /* --- Scrollbar --- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    .light-theme::-webkit-scrollbar-thumb { background: #ccc; }

    /* Sidebar Styling */
    .sidebar {
      width: 280px;
      background: var(--card-bg);
      padding: 30px 0;
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: var(--transition);
      border-right: 1px solid var(--border-color);
    }

    .logo-container { padding: 0 20px 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
    .logo { display: flex; align-items: center; gap: 15px; font-size: 1.8rem; font-weight: 700; color: var(--text); }
    .logo i { color: var(--primary); background: rgba(67, 97, 238, 0.15); padding: 12px; border-radius: 12px; font-size: 1.2rem; }
    .sidebar nav { padding: 20px 0; display: flex; flex-direction: column; gap: 8px; flex-grow: 1; }
    .nav-link {
      display: flex; align-items: center; gap: 15px; color: var(--text-secondary); text-decoration: none;
      padding: 15px 25px; transition: var(--transition); font-size: 1.05rem; border-left: 4px solid transparent; position: relative;
    }
    .nav-link:hover, .nav-link.active {
      color: var(--text); border-left: 4px solid var(--primary); background: rgba(67, 97, 238, 0.1);
    }
    .nav-link i { width: 24px; text-align: center; font-size: 1.2rem; }
    .sidebar-footer { margin-top: auto; padding: 25px 25px 0; border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem; }
    .sidebar-footer p { margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .sidebar-footer i { color: var(--primary); }

    /* Main Content Area */
    .main-content { flex: 1; padding: 30px; display: flex; flex-direction: column; gap: 30px; overflow-y: auto; }
    .page-view { display: none; }
    .page-view.active { display: block; }

    /* Header Styling */
    .header {
      display: flex; justify-content: space-between; align-items: center; padding: 25px;
      background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow);
    }
    .header-title h1 {
      font-size: 2rem; font-weight: 600; margin-bottom: 8px;
      background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header-title p { color: var(--text-secondary); font-size: 1.05rem; }

    /* Card Styling */
    .card {
      background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow);
      padding: 30px; transition: var(--transition); position: relative; border: 1px solid var(--border-color);
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); }
    .light-theme .card:hover { box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); }
    .card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);
    }
    .card-title { font-size: 1.4rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .card-title i { color: var(--primary); }

    /* --- General UI Elements --- */
    .button {
      padding: 12px 25px; background: var(--primary); border: none; border-radius: 8px; color: white;
      font-weight: 500; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 8px;
    }
    .button:hover { background: var(--primary-dark); transform: translateY(-2px); }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); }
    .form-group input, .form-group select {
      width: 100%; padding: 10px; background: var(--dark); border: 1px solid var(--border-color);
      border-radius: 8px; color: var(--text);
    }

    /* Dashboard Specific */
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
    .mode-toggle { display: flex; background: var(--dark); border-radius: 50px; padding: 5px; margin-bottom: 20px; border: 1px solid var(--border-color); }
    .mode-btn { flex: 1; padding: 10px 15px; text-align: center; border-radius: 50px; cursor: pointer; transition: var(--transition); font-weight: 500; border: none; background: transparent; color: var(--text-secondary); }
    .mode-btn.active { background: var(--primary); color: var(--text); }
    .video-container { position: relative; border-radius: var(--border-radius); overflow: hidden; margin-bottom: 25px; background: #000; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); }
    .video-placeholder { color: var(--text-secondary); text-align: center; }
    .video-placeholder i { font-size: 4rem; margin-bottom: 1rem; }
    .video-container video, .video-container img { width: 100%; height: 100%; object-fit: cover; }
    .video-controls { display: flex; gap: 15px; margin-top: 20px; }
    .control-btn { flex: 1; padding: 15px 20px; background: rgba(255, 255, 255, 0.07); border: none; border-radius: 10px; color: var(--text); font-weight: 500; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px; }
    .light-theme .control-btn { background: rgba(0,0,0,0.05); }
    .control-btn:hover { transform: translateY(-3px); background: rgba(255,255,255,0.15); }
    .light-theme .control-btn:hover { background: rgba(0,0,0,0.1); }
    .control-btn.primary { background: var(--primary); color: white; }
    .control-btn.danger { background: var(--danger); color: white; }
    .control-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    #dropArea.dragover { background-color: rgba(67, 97, 238, 0.1); border-color: var(--primary); }
    .chart-container { height: 280px; margin-top: 25px; position: relative; }
    .alerts-container { max-height: 400px; overflow-y: auto; padding-right: 10px; }

    /* Alert Card & Log Styling */
    .alert-card { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; padding: 15px; border-radius: 12px; transition: opacity 0.3s ease, transform 0.3s ease; }
    .alert-card.critical { background: rgba(247, 37, 133, 0.1); border-left: 4px solid var(--danger); }
    .alert-card.warning { background: rgba(251, 146, 60, 0.1); border-left: 4px solid var(--warning); }
    .alert-card.info { background: rgba(76, 201, 240, 0.1); border-left: 4px solid var(--info); }
    .alert-icon { font-size: 1.5rem; }
    .alert-card.critical .alert-icon { color: var(--danger); }
    .alert-card.warning .alert-icon { color: var(--warning); }
    .alert-card.info .alert-icon { color: var(--info); }
    .alert-content h3 { font-size: 1.1rem; margin: 0; font-weight: 500; }
    .alert-content p { color: var(--text-secondary); font-size: 0.9rem; margin: 0; }
    .alert-close { margin-left: auto; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; transition: var(--transition); }
    .alert-close:hover { color: var(--text); transform: rotate(90deg); }

    /* Cameras View */
    .cameras-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; }
    .camera-card { padding: 25px; cursor: grab; transition: all 0.4s ease; }
    .camera-card.dragging { opacity: 0.4; cursor: grabbing; transform: scale(0.98); }
    .camera-card.alert { border-color: var(--danger) !important; box-shadow: 0 0 25px var(--danger) !important; }
    .camera-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .camera-title { font-weight: 600; font-size: 1.3rem; }
    .camera-status { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; background: var(--dark); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--border-color); }
    .camera-status .status-indicator { width: 8px; height: 8px; border-radius: 50%; background: #666; transition: background 0.3s; }
    .camera-status.streaming .status-indicator { background: var(--success); animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .camera-feed { height: 220px; }
    .camera-stream-controls { margin-top: 15px; }
    .camera-stream-controls .url-input { width: 100%; padding: 10px; background: var(--dark); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text); margin-bottom: 10px; }
    .camera-graph { height: 80px; margin-top: 20px; }

    /* History & Alerts Page */
    .log-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .log-table th, .log-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
    .log-table th { color: var(--text-secondary); font-weight: 500; }
    .log-table .status-pill { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
    .log-table .status-critical { background: rgba(247, 37, 133, 0.2); color: var(--danger); }
    .log-table .status-pending { background: rgba(251, 146, 60, 0.2); color: var(--warning); }
    .log-table .status-reviewed { background: rgba(74, 222, 128, 0.2); color: var(--success); }

    /* Settings Page */
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
    .toggle-switch { display: flex; align-items: center; justify-content: space-between; }
    .toggle-switch label { margin: 0; }
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .light-theme .slider { background-color: #ddd; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }

    /* Responsive Adjustments */
    @media (max-width: 1400px) { .dashboard-grid, .cameras-grid, .settings-grid { grid-template-columns: 1fr; } }
    @media (max-width: 992px) { .sidebar { width: 80px; } .sidebar .logo span, .sidebar .nav-link span, .sidebar-footer { display: none; } .nav-link { justify-content: center; } }
    @media (max-width: 768px) { body { flex-direction: column; } .sidebar { width: 100%; flex-direction: row; padding: 15px; justify-content: space-between; height: auto; } .logo-container, .sidebar nav span, .sidebar-footer { display: none; } .sidebar nav { flex-direction: row; padding: 0; } .header { flex-direction: column; gap: 20px; text-align: center; } }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo-container"><div class="logo"><i class="fas fa-shield-halved"></i><span>Avertix</span></div></div>
    <nav>
      <a href="#" class="nav-link active" data-view="dashboard-view"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
      <a href="#" class="nav-link" data-view="cameras-view"><i class="fas fa-video"></i><span>Cameras</span></a>
      <a href="#" class="nav-link" data-view="history-view"><i class="fas fa-history"></i><span>History</span></a>
      <a href="#" class="nav-link" data-view="alerts-view"><i class="fas fa-bell"></i><span>Alerts</span></a>
      <a href="#" class="nav-link" data-view="settings-view"><i class="fas fa-cog"></i><span>Settings</span></a>
    </nav>
    <div class="sidebar-footer">
      <p><i class="fas fa-building"></i> Managed by: Myteam.ai</p>
      <p><i class="fas fa-code-branch"></i> Version: 3.0.0 (API-Connected)</p>
    </div>
  </div>

  <main class="main-content">
    <!-- Dashboard View -->
    <div id="dashboard-view" class="page-view active">
      <div class="header"><div class="header-title"><h1>System Dashboard</h1><p>Unified analysis and threat assessment</p></div></div>
      <div class="card">
        <div class="card-header"><h2 class="card-title"><i class="fas fa-cogs"></i> Detection Interface</h2></div>
        <div class="mode-toggle">
          <button class="mode-btn active" data-mode="realtime">Real-time Webcam</button>
          <button class="mode-btn" data-mode="offline">Offline Analysis</button>
        </div>
        <div id="realtimeSection">
          <div class="video-container"><video id="realtimeVideo" autoplay muted playsinline style="display:none;"></video><div class="video-placeholder" id="realtimeVideoPlaceholder"><i class="fas fa-video-slash"></i><p>Webcam Inactive</p></div></div>
          <div class="video-controls"><button class="control-btn primary" id="startRealtimeBtn"><i class="fas fa-play"></i> Start</button><button class="control-btn danger" id="stopRealtimeBtn" disabled><i class="fas fa-stop"></i> Stop</button></div>
        </div>
        <div id="offlineSection" style="display: none;">
          <div class="video-container" id="dropArea"><video id="offlineVideo" controls style="display:none;"></video><div class="video-placeholder" id="offlinePlaceholder"><i class="fas fa-upload"></i><p>Drag & Drop or Click to Upload</p></div></div>
          <input type="file" id="videoFile" accept="video/*" style="display: none;"><div class="video-controls"><button class="control-btn" id="browseBtn"><i class="fas fa-folder-open"></i> Browse</button><button class="control-btn primary" id="analyzeBtn" disabled><i class="fas fa-cogs"></i> Analyze</button></div>
        </div>
      </div>
      <div class="dashboard-grid">
        <div class="card"><div class="card-header"><h2 class="card-title"><i class="fas fa-chart-line"></i> Analysis Chart</h2></div><div class="chart-container"><canvas id="mainChart"></canvas></div></div>
        <div class="card"><div class="card-header"><h2 class="card-title"><i class="fas fa-exclamation-triangle"></i> Recent Alerts</h2></div><div id="alertsContainer" class="alerts-container"></div></div>
      </div>
    </div>

    <!-- Cameras View -->
    <div id="cameras-view" class="page-view"><div class="header"><div class="header-title"><h1>Multi-Camera Surveillance</h1><p>Drag to reorder. High-threat feeds are prioritized.</p></div></div><div class="cameras-grid" id="cameras-grid"></div></div>

    <!-- History View -->
    <div id="history-view" class="page-view">
      <div class="header"><div class="header-title"><h1>Event History</h1><p>A log of all recorded critical threat events.</p></div></div>
      <div class="card">
        <div class="card-header"><h2 class="card-title"><i class="fas fa-history"></i> Critical Events Log</h2></div>
        <div class="flex justify-between mb-4">
          <div class="relative">
            <input type="text" id="history-search" class="pl-10 pr-4 py-2 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search events...">
            <i class="fas fa-search absolute left-3 top-3 text-gray-500"></i>
          </div>
          <button id="clear-history-btn" class="button bg-red-600 hover:bg-red-700 flex items-center gap-2">
            <i class="fas fa-trash-alt"></i> Clear History
          </button>
        </div>
        <div style="overflow-x: auto;">
          <table class="log-table">
            <thead><tr><th>Camera</th><th>Threat Level</th><th>Timestamp</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="history-log-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Alerts View -->
    <div id="alerts-view" class="page-view">
      <div class="header"><div class="header-title"><h1>Alerts Management</h1><p>Review and filter all system alerts.</p></div></div>
      <div class="card">
        <div class="card-header"><h2 class="card-title"><i class="fas fa-filter"></i> Filter Alerts</h2></div>
        <div class="dashboard-grid">
            <div class="form-group"><label for="filter-severity">Severity</label><select id="filter-severity"><option value="all">All</option><option value="critical">Critical</option><option value="warning">Warning</option><option value="info">Info</option></select></div>
            <div class="form-group"><label for="filter-date-start">Start Date</label><input type="date" id="filter-date-start"></div>
            <div class="form-group"><label for="filter-date-end">End Date</label><input type="date" id="filter-date-end"></div>
        </div>
        <button class="button" id="apply-filters-btn">Apply Filters</button>
      </div>
      <div class="card">
        <div class="card-header"><h2 class="card-title"><i class="fas fa-bell"></i> Filtered Alerts Log</h2></div>
        <div id="full-alerts-log" class="alerts-container"></div>
      </div>
    </div>

    <!-- Settings View -->
    <div id="settings-view" class="page-view">
      <div class="header"><div class="header-title"><h1>System Settings</h1><p>Configure Avertix to your needs.</p></div></div>
      <div class="settings-grid">
        <div class="card">
            <div class="card-header"><h2 class="card-title"><i class="fas fa-cogs"></i> General</h2></div>
            <div class="form-group">
                <label for="alert-threshold-slider">Alert Sensitivity Threshold: <span id="threshold-value">75</span>%</label>
                <input type="range" min="50" max="95" value="75" id="alert-threshold-slider">
            </div>
            <div class="form-group toggle-switch">
                <label>Email Notifications</label>
                <label class="switch"><input type="checkbox" checked><span class="slider"></span></label>
            </div>
            <div class="form-group toggle-switch">
                <label>SMS Notifications</label>
                <label class="switch"><input type="checkbox"><span class="slider"></span></label>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h2 class="card-title"><i class="fas fa-palette"></i> Appearance</h2></div>
            <div class="form-group">
                <label>Theme</label>
                <div class="video-controls">
                    <button class="control-btn" id="theme-dark-btn"><i class="fas fa-moon"></i> Dark</button>
                    <button class="control-btn" id="theme-light-btn"><i class="fas fa-sun"></i> Light</button>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h2 class="card-title"><i class="fas fa-user"></i> User Profile</h2></div>
            <div class="form-group"><label>Username</label><input type="text" value="Admin" disabled></div>
            <div class="form-group"><label>Email</label><input type="email" value="admin@myteam.ai" disabled></div>
            <button class="button">Change Password</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
     // MERGE-NOTE: Using the API configuration from the original file.
    const CONFIG = {
        API_ENDPOINTS: {
            REALTIME_FRAME: '/realtime-frame/',
            ANALYZE_UPLOAD: '/analyze-upload/',
            REALTIME_CAM: '/realtime-cam',
            PROXY: '/proxy/',
            KINESIS_STREAM: '/kinesis-stream'
        },
        STREAM_FPS: 5,
        ALERT_DURATION: 10000,
        
        CAMERA_CHART_POINTS: 20
    };

    const state = {
        activeView: 'dashboard-view', activeDashboardMode: 'realtime',
        settings: { alertThreshold: 75 },
        cameras: Array.from({ length: 10 }, (_, i) => ({
            id: i + 1,
            name: ['Main Entrance', 'Parking Lot A', 'Lobby', 'Corridor B', 'Rooftop Access', 'Service Elevator', 'East Stairwell', 'Loading Bay', 'Parking Lot B', 'West Perimeter'][i],
            prob: 0, isStreaming: false, url: '',
            chart: null, chartData: Array(CONFIG.CAMERA_CHART_POINTS).fill(0),
            analysisInterval: null, canvas: null, ctx: null, // MERGE-NOTE: Added properties for API logic
            hasActiveAlert: false // Track if camera has an active alert
        })),
        allAlerts: [], eventHistory: [], draggedElement: null, isWebcamStreaming: false,
        activeCameraAlerts: new Set() // Track cameras with active alerts
    };

        state.cameras[0].url = 'http://23.254.240.219:8083/mjpg/video.mjpg';
        state.cameras[3].url = 'http://158.58.130.148/mjpg/video.mjpg';
        state.cameras[1].url = 'arn:aws:kinesisvideo:us-west-2:123456789012:stream/MyKVSStream/1678901234567'; // Example KVS ARN

      const elements = {
        body: document.body,
        views: { dashboard: document.getElementById('dashboard-view'), cameras: document.getElementById('cameras-view'), history: document.getElementById('history-view'), alerts: document.getElementById('alerts-view'), settings: document.getElementById('settings-view') },
        navLinks: document.querySelectorAll('.nav-link'),
        modeToggleButtons: document.querySelectorAll('.mode-btn'), realtimeSection: document.getElementById('realtimeSection'), offlineSection: document.getElementById('offlineSection'),
        realtimeVideo: document.getElementById('realtimeVideo'), realtimeVideoPlaceholder: document.getElementById('realtimeVideoPlaceholder'), startRealtimeBtn: document.getElementById('startRealtimeBtn'), stopRealtimeBtn: document.getElementById('stopRealtimeBtn'),
        dropArea: document.getElementById('dropArea'), offlineVideo: document.getElementById('offlineVideo'), offlinePlaceholder: document.getElementById('offlinePlaceholder'),
        videoFileInput: document.getElementById('videoFile'), browseBtn: document.getElementById('browseBtn'), analyzeBtn: document.getElementById('analyzeBtn'),
        mainChartCtx: document.getElementById('mainChart').getContext('2d'), alertsContainer: document.getElementById('alertsContainer'),
        camerasGrid: document.getElementById('cameras-grid'),
        historyLogBody: document.getElementById('history-log-body'),
        fullAlertsLog: document.getElementById('full-alerts-log'), filterSeverity: document.getElementById('filter-severity'),
        filterDateStart: document.getElementById('filter-date-start'), filterDateEnd: document.getElementById('filter-date-end'), applyFiltersBtn: document.getElementById('apply-filters-btn'),
        alertThresholdSlider: document.getElementById('alert-threshold-slider'), thresholdValue: document.getElementById('threshold-value'),
        themeDarkBtn: document.getElementById('theme-dark-btn'), themeLightBtn: document.getElementById('theme-light-btn'),
        clearHistoryBtn: document.getElementById('clear-history-btn'),
        historySearch: document.getElementById('history-search')
      };

      let mainChart;
      let dashboardWebcamCanvas, dashboardWebcamCtx; // MERGE-NOTE: For dashboard webcam logic

      const createMainChart = () => { if (mainChart) mainChart.destroy(); mainChart = new Chart(elements.mainChartCtx, { type: 'line', data: { labels: Array(30).fill(''), datasets: [{ label: 'Violence Probability', data: Array(30).fill(0), borderColor: 'var(--accent)', backgroundColor: 'rgba(247, 37, 133, 0.1)', borderWidth: 2.5, tension: 0.4, fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 0, max: 100, ticks: { color: 'var(--text-secondary)', callback: v => `${v}%` } }, x: { grid: { display: false }, ticks: { display: false } } }, animation: { duration: 0 } } }); };
      const switchView = (viewId) => { state.activeView = viewId; document.querySelectorAll('.page-view').forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); elements.navLinks.forEach(l => l.classList.toggle('active', l.dataset.view === viewId)); if (viewId === 'cameras-view') renderCameraCards(); if (viewId === 'history-view') renderHistoryLog(); if (viewId === 'alerts-view') renderAlertsLog(); };
      const switchDashboardMode = (mode) => { state.activeDashboardMode = mode; elements.modeToggleButtons.forEach(b => b.classList.toggle('active', b.dataset.mode === mode)); elements.realtimeSection.style.display = mode === 'realtime' ? 'block' : 'none'; elements.offlineSection.style.display = mode === 'offline' ? 'block' : 'none'; if(state.isWebcamStreaming) stopRealtime(); createMainChart(); };
      
      const showAlert = (message, type = 'warning', source = 'System') => { 
        const alertId = `alert-${Date.now()}`;
        const alertData = { id: alertId, message, type, source, timestamp: new Date() };
        state.allAlerts.unshift(alertData);
        
        const alertCard = document.createElement('div');
        alertCard.className = `alert-card ${type}`;
        alertCard.innerHTML = `<div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="alert-content"><h3>${source}</h3><p>${message}</p></div><button class="alert-close"><i class="fas fa-times"></i></button>`;
        
        if (elements.alertsContainer.childElementCount < 5) {
          elements.alertsContainer.prepend(alertCard);
        }
        
        const removeAlert = () => {
          alertCard.style.opacity = '0';
          alertCard.style.transform = 'translateX(20px)';
          setTimeout(() => alertCard.remove(), 300);
        };
        
        alertCard.querySelector('.alert-close').addEventListener('click', removeAlert);
        setTimeout(removeAlert, CONFIG.ALERT_DURATION);
        
        // Only add to history if it's a critical alert and not already tracked for this camera
        if (type === 'critical') {
          const camera = state.cameras.find(c => c.name === source);
          if (camera && !camera.hasActiveAlert) {
            camera.hasActiveAlert = true;
            state.activeCameraAlerts.add(camera.id);
            state.eventHistory.unshift({ 
              cameraName: source, 
              prob: message.match(/\d+/)[0], 
              timestamp: alertData.timestamp,
              status: 'pending',
              cameraId: camera.id
            });
            renderHistoryLog();
          }
        }
      };
      
      const renderHistoryLog = () => {
        const searchTerm = elements.historySearch.value.toLowerCase();
        const filteredHistory = state.eventHistory.filter(event => 
          event.cameraName.toLowerCase().includes(searchTerm) || 
          event.prob.toString().includes(searchTerm) ||
          event.timestamp.toLocaleString().toLowerCase().includes(searchTerm)
        );
        
        elements.historyLogBody.innerHTML = filteredHistory.map(event => `
          <tr>
            <td>${event.cameraName}</td>
            <td><span class="status-pill status-critical">${event.prob}%</span></td>
            <td>${event.timestamp.toLocaleString()}</td>
            <td><span class="status-pill status-${event.status}">${event.status.charAt(0).toUpperCase() + event.status.slice(1)}</span></td>
            <td>
              ${event.status === 'pending' ? 
                `<button class="button bg-green-600 hover:bg-green-700" data-camera-id="${event.cameraId}" data-action="resolve">
                  <i class="fas fa-check-circle"></i> Resolve
                </button>` : 
                `<button class="button" style="padding: 5px 10px; font-size: 0.8rem;">
                  <i class="fas fa-eye"></i> View Clip
                </button>`
              }
            </td>
          </tr>
        `).join('') || `<tr><td colspan="5" style="text-align:center;">No critical events recorded yet.</td></tr>`;
      };
      
      const resolveAlert = (cameraId) => {
        const camera = state.cameras.find(c => c.id === cameraId);
        if (camera) {
          camera.hasActiveAlert = false;
          state.activeCameraAlerts.delete(cameraId);
          
          // Update the event history to mark as reviewed
          state.eventHistory = state.eventHistory.map(event => {
            if (event.cameraId === cameraId && event.status === 'pending') {
              return { ...event, status: 'reviewed' };
            }
            return event;
          });
          
          renderHistoryLog();
        }
      };
      
      const clearHistory = () => {
        if (confirm('Are you sure you want to clear all event history? This action cannot be undone.')) {
          state.eventHistory = [];
          state.activeCameraAlerts.clear();
          state.cameras.forEach(camera => {
            camera.hasActiveAlert = false;
          });
          renderHistoryLog();
        }
      };

      const renderAlertsLog = (alerts = state.allAlerts) => { elements.fullAlertsLog.innerHTML = alerts.map(alert => `<div class="alert-card ${alert.type}"><div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="alert-content"><h3>${alert.source} (${alert.type})</h3><p>${alert.message} - ${alert.timestamp.toLocaleTimeString()}</p></div></div>`).join('') || `<p style="text-align:center; color: var(--text-secondary);">No alerts to display.</p>`; };
      const renderCameraCards = () => { elements.camerasGrid.innerHTML = ''; state.cameras.forEach(cam => { const card = document.createElement('div'); card.className = 'camera-card card'; card.id = `cam-card-${cam.id}`; card.draggable = true; card.innerHTML = `<div class="camera-header"><h3 class="camera-title">${cam.name}</h3><div class="camera-status" id="status-cont-${cam.id}"><div class="status-indicator"></div><span id="status-text-${cam.id}">OFFLINE</span></div></div><div class="video-container camera-feed"><img id="img-feed-${cam.id}" src="" alt="Camera Feed" style="display:none;"><video id="video-feed-${cam.id}" autoplay muted playsinline style="display:none;"></video><div class="video-placeholder" id="placeholder-${cam.id}"><i class="fas fa-power-off"></i></div></div><div class="camera-stream-controls"><input type="text" class="url-input" id="url-input-${cam.id}" value="${cam.url}" placeholder="Enter HTTP Stream URL or KVS ARN"><div class="video-controls"><button class="control-btn" data-cam-id="${cam.id}" data-action="start"><i class="fas fa-play"></i> Start</button></div></div><div class="camera-graph"><canvas id="cam-chart-${cam.id}"></canvas></div>`; elements.camerasGrid.appendChild(card); const ctx = document.getElementById(`cam-chart-${cam.id}`).getContext('2d'); cam.chart = new Chart(ctx, { type: 'line', data: { labels: Array(CONFIG.CAMERA_CHART_POINTS).fill(''), datasets: [{ data: cam.chartData, borderColor: 'var(--secondary)', backgroundColor: 'rgba(76, 201, 240, 0.1)', borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false, min: 0, max: 100 }, x: { display: false } } } }); }); };

      // --- MERGE-NOTE: Real API logic for multi-camera streams starts here ---
      const updateCameraUI = (cam, { prob, isStreaming, statusText }) => {
          const card = document.getElementById(`cam-card-${cam.id}`), statusCont = document.getElementById(`status-cont-${cam.id}`), statusTextEl = document.getElementById(`status-text-${cam.id}`), startBtn = card.querySelector('[data-action="start"],[data-action="stop"]'), imgFeed = document.getElementById(`img-feed-${cam.id}`), videoFeed = document.getElementById(`video-feed-${cam.id}`), placeholder = document.getElementById(`placeholder-${cam.id}`);
          if (prob !== undefined) {
              cam.prob = prob; cam.chartData.shift(); cam.chartData.push(prob); cam.chart.data.datasets[0].data = cam.chartData; cam.chart.update('none');
              const isAlert = prob > state.settings.alertThreshold;
              card.classList.toggle('alert', isAlert);
              
              // Only trigger alert if crossing the threshold and no active alert exists
              if (isAlert && !cam.hasActiveAlert) {
                  prioritizeCamera(cam.id);
                  showAlert(`Critical threat detected: ${Math.round(prob)}%`, 'critical', cam.name);
              }
          }
          if (isStreaming !== undefined) {
              cam.isStreaming = isStreaming; statusCont.classList.toggle('streaming', isStreaming); startBtn.innerHTML = isStreaming ? `<i class="fas fa-stop"></i> Stop` : `<i class="fas fa-play"></i> Start`;
              startBtn.dataset.action = isStreaming ? 'stop' : 'start'; startBtn.classList.toggle('danger', isStreaming);
              placeholder.style.display = isStreaming ? 'none' : 'flex';
              if (!isStreaming) { imgFeed.style.display = 'none'; videoFeed.style.display = 'none'; }
          }
          if (statusText !== undefined) statusTextEl.innerText = statusText;
      };

      const startHttpStream = async (cam) => {
          const urlInput = document.getElementById(`url-input-${cam.id}`);
          cam.url = urlInput.value.trim();
          if (!cam.url) return showAlert(`URL or ARN is missing for ${cam.name}.`, 'error', cam.name);

          updateCameraUI(cam, { isStreaming: true, statusText: 'CONNECTING' });

          const imgFeed = document.getElementById(`img-feed-${cam.id}`);
          const videoFeed = document.getElementById(`video-feed-${cam.id}`);
          let feedElement;
          const isKinesis = cam.url.startsWith('arn:aws:kinesisvideo:');

          try {
              if (isKinesis) {
                  const response = await fetch(CONFIG.API_ENDPOINTS.KINESIS_STREAM, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ arn: cam.url }) });
                  if (!response.ok) throw new Error(`API Error ${response.status}`);
                  const { streamUrl } = await response.json();
                                  
                  videoFeed.style.display = 'block';
                  feedElement = videoFeed;
                  if (Hls.isSupported()) {
                      const hls = new Hls(); hls.loadSource(streamUrl); hls.attachMedia(videoFeed);
                  } else if (videoFeed.canPlayType('application/vnd.apple.mpegurl')) {
                      videoFeed.src = streamUrl;
                  }
              } else {
                  imgFeed.style.display = 'block';
                  feedElement = imgFeed;
                  feedElement.src = `${CONFIG.API_ENDPOINTS.PROXY}?url=${encodeURIComponent(cam.url)}`;
              }

              updateCameraUI(cam, { statusText: 'STREAMING' });
                          
              // Start analysis loop
              cam.analysisInterval = setInterval(async () => {
                  if (!cam.isStreaming) return;
                  if (!cam.canvas) { cam.canvas = document.createElement('canvas'); cam.canvas.width = 224; cam.canvas.height = 224; cam.ctx = cam.canvas.getContext('2d'); }
                                  
                  cam.ctx.drawImage(feedElement, 0, 0, 224, 224);
                  const blob = await new Promise(resolve => cam.canvas.toBlob(resolve, 'image/jpeg', 0.8));
                  const b64 = await new Promise((resolve) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result.split(',')[1]); reader.readAsDataURL(blob); });

                  const resp = await fetch(CONFIG.API_ENDPOINTS.REALTIME_CAM, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ frame: b64, stream_id: cam.id }) });
                  if (!resp.ok) throw new Error(`Prediction API failed for ${cam.name}`);
                  const { prediction } = await resp.json();
                  updateCameraUI(cam, { prob: prediction * 100 });

              }, 1000 / CONFIG.STREAM_FPS);

          } catch (error) {
              showAlert(`Failed to start stream for ${cam.name}: ${error.message}`, 'error', cam.name);
              stopHttpStream(cam);
          }
      };
          
      const stopHttpStream = (cam) => {
          clearInterval(cam.analysisInterval);
          cam.analysisInterval = null;
          if(cam.canvas) { cam.canvas.remove(); cam.canvas = null; cam.ctx = null; }
          document.getElementById(`img-feed-${cam.id}`).src = '';
          document.getElementById(`video-feed-${cam.id}`).src = '';
          updateCameraUI(cam, { isStreaming: false, statusText: 'OFFLINE', prob: 0 });
      };

      const prioritizeCamera = (camId) => { const card = document.getElementById(`cam-card-${camId}`); if (elements.camerasGrid.firstChild.id !== card.id) { elements.camerasGrid.prepend(card); syncCameraStateOrder(); } };
      const syncCameraStateOrder = () => { state.cameras = Array.from(elements.camerasGrid.querySelectorAll('.camera-card')).map(card => state.cameras.find(c => c.id === parseInt(card.id.replace('cam-card-', '')))); };

      // --- MERGE-NOTE: Real API logic for dashboard (webcam & offline) starts here ---
      async function startRealtime() {
          if (state.isWebcamStreaming) return;
          state.isWebcamStreaming = true;
          elements.startRealtimeBtn.disabled = true;
          elements.stopRealtimeBtn.disabled = false;
          elements.realtimeVideo.style.display = 'block';
          elements.realtimeVideoPlaceholder.style.display = 'none';
          try {
              elements.realtimeVideo.srcObject = await navigator.mediaDevices.getUserMedia({ video: true });
          } catch (err) { showAlert('Failed to access webcam: ' + err.message, 'error'); stopRealtime(); return; }
          dashboardWebcamCanvas = document.createElement('canvas'); dashboardWebcamCanvas.width = 224; dashboardWebcamCanvas.height = 224; dashboardWebcamCtx = dashboardWebcamCanvas.getContext('2d');
          createMainChart(); // Reset chart
          captureLoop();
      }
      function stopRealtime() {
          state.isWebcamStreaming = false;
          elements.startRealtimeBtn.disabled = false;
          elements.stopRealtimeBtn.disabled = true;
          if (elements.realtimeVideo.srcObject) { elements.realtimeVideo.srcObject.getTracks().forEach(t => t.stop()); elements.realtimeVideo.srcObject = null; }
          elements.realtimeVideo.style.display = 'none'; elements.realtimeVideoPlaceholder.style.display = 'block';
      }
      async function captureLoop() {
          if (!state.isWebcamStreaming) return;
          dashboardWebcamCtx.drawImage(elements.realtimeVideo, 0, 0, 224, 224);
          const blob = await new Promise(resolve => dashboardWebcamCanvas.toBlob(resolve, 'image/jpeg', 0.8));
          const b64 = await new Promise((resolve) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result.split(',')[1]); reader.readAsDataURL(blob); });
                  
          try {
              const response = await fetch(CONFIG.API_ENDPOINTS.REALTIME_FRAME, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ frame: b64 }) });
              if (!response.ok) throw new Error(`API Error ${response.status}`);
              const { prediction } = await response.json();
                          
              mainChart.data.labels.shift(); mainChart.data.datasets[0].data.shift();
              mainChart.data.labels.push(''); mainChart.data.datasets[0].data.push(prediction * 100);
              mainChart.update('none');
          } catch (error) { console.error('Error in real-time prediction:', error); }
          setTimeout(captureLoop, 200);
      }
          
      async function analyzeVideo() {
        const file = elements.videoFileInput.files[0];
        if (!file) { showAlert('Please select a video file first', 'error'); return; }
        elements.analyzeBtn.disabled = true; elements.analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        const formData = new FormData(); formData.append('file', file);
        try {
          const response = await fetch(CONFIG.API_ENDPOINTS.ANALYZE_UPLOAD, { method: 'POST', body: formData });
          if (!response.ok) throw new Error(`API Error ${response.status}`);
          const data = await response.json();
                  
          const labels = data.predictions.map((_, i) => ((i * 16) / data.fps).toFixed(1) + 's');
          const dataPoints = data.predictions.map(p => p * 100);
          mainChart.data.labels = labels;
          mainChart.data.datasets[0].data = dataPoints;
          mainChart.update();
          showAlert(`Analysis complete. Max probability: ${Math.round(Math.max(...dataPoints))}%`, 'info');
        } catch (error) { showAlert('Error analyzing video: ' + error.message, 'error'); }
         finally { elements.analyzeBtn.disabled = false; elements.analyzeBtn.innerHTML = '<i class="fas fa-cogs"></i> Analyze'; }
      }

      // --- EVENT LISTENERS ---
      elements.navLinks.forEach(l => l.addEventListener('click', (e) => { e.preventDefault(); switchView(l.dataset.view); }));
      elements.modeToggleButtons.forEach(b => b.addEventListener('click', () => switchDashboardMode(b.dataset.mode)));
      elements.camerasGrid.addEventListener('click', (e) => { const b = e.target.closest('button[data-cam-id]'); if (b) { const cam = state.cameras.find(c => c.id === parseInt(b.dataset.camId)); if (b.dataset.action === 'start') startHttpStream(cam); else stopHttpStream(cam); } });
      elements.camerasGrid.addEventListener('dragstart', e => { if (e.target.classList.contains('camera-card')) { state.draggedElement = e.target; e.target.classList.add('dragging'); } });
      elements.camerasGrid.addEventListener('dragend', e => { if (state.draggedElement) { state.draggedElement.classList.remove('dragging'); state.draggedElement = null; } });
      elements.camerasGrid.addEventListener('dragover', e => { e.preventDefault(); const afterElement = [...elements.camerasGrid.querySelectorAll('.camera-card:not(.dragging)')].reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = e.clientY - box.top - box.height / 2; return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest; }, { offset: Number.NEGATIVE_INFINITY }).element; if (afterElement == null) { elements.camerasGrid.appendChild(state.draggedElement); } else { elements.camerasGrid.insertBefore(state.draggedElement, afterElement); } });
      elements.camerasGrid.addEventListener('drop', e => { e.preventDefault(); if (state.draggedElement) syncCameraStateOrder(); });
      // DASHBOARD LISTENERS:
      elements.startRealtimeBtn.addEventListener('click', startRealtime);
      elements.stopRealtimeBtn.addEventListener('click', stopRealtime);
      elements.browseBtn.addEventListener('click', () => elements.videoFileInput.click());
      elements.videoFileInput.addEventListener('change', (e) => e.target.files.length && handleFileSelect(e.target.files[0]));
      elements.dropArea.addEventListener('dragover', (e) => { e.preventDefault(); e.target.closest('.video-container').classList.add('dragover'); });
      elements.dropArea.addEventListener('dragleave', (e) => e.target.closest('.video-container').classList.remove('dragover'));
      elements.dropArea.addEventListener('drop', (e) => { e.preventDefault(); e.target.closest('.video-container').classList.remove('dragover'); e.dataTransfer.files.length && handleFileSelect(e.dataTransfer.files[0]); });
      function handleFileSelect(file) { if(file.type.startsWith('video/')){ const url = URL.createObjectURL(file); elements.offlineVideo.src = url; elements.offlineVideo.style.display='block'; elements.offlinePlaceholder.style.display='none'; elements.analyzeBtn.disabled=false; } else { showAlert('Invalid file type. Please upload a video.', 'error'); }}
      elements.analyzeBtn.addEventListener('click', analyzeVideo);
      // SETTINGS LISTENERS:
      elements.alertThresholdSlider.addEventListener('input', (e) => { state.settings.alertThreshold = parseInt(e.target.value); elements.thresholdValue.textContent = e.target.value; });
      elements.themeDarkBtn.addEventListener('click', () => elements.body.classList.remove('light-theme'));
      elements.themeLightBtn.addEventListener('click', () => elements.body.classList.add('light-theme'));
      // ALERTS FILTER LISTENERS:
      elements.applyFiltersBtn.addEventListener('click', () => { const severity = elements.filterSeverity.value; const startDate = elements.filterDateStart.valueAsDate; const endDate = elements.filterDateEnd.valueAsDate; if(endDate) endDate.setHours(23, 59, 59, 999); const filtered = state.allAlerts.filter(alert => { const sevMatch = (severity === 'all' || alert.type === severity); const startMatch = (!startDate || alert.timestamp >= startDate); const endMatch = (!endDate || alert.timestamp <= endDate); return sevMatch && startMatch && endMatch; }); renderAlertsLog(filtered); });
      
      // HISTORY LISTENERS
      elements.historyLogBody.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-action="resolve"]');
        if (button) {
          const cameraId = parseInt(button.dataset.cameraId);
          resolveAlert(cameraId);
        }
      });
      
      elements.clearHistoryBtn.addEventListener('click', clearHistory);
      elements.historySearch.addEventListener('input', renderHistoryLog);

      // --- INITIALIZATION ---
      const init = () => { switchView('dashboard-view'); createMainChart(); showAlert("Welcome to Avertix. Systems online and API connected.", "info"); };
      init();
    });
  </script>
</body>
</html>