<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avertix - Advanced Multi-Camera Violence Detection</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> 
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #4cc9f0;
      --accent: #f72585;
      --dark: #121212;
      --darker: #0a0a0a;
      --card-bg: #1e1e1e;
      --success: #4ade80;
      --danger: #f72585;
      --warning: #fb923c;
      --info: #4cc9f0;
      --text: #ffffff;
      --text-secondary: #b0b0b0;
      --border-color: rgba(255, 255, 255, 0.08);
      --border-radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }

    .light-theme {
      --dark: #f5f5f5;
      --darker: #e0e0e0;
      --card-bg: #ffffff;
      --text: #121212;
      --text-secondary: #555555;
      --border-color: rgba(0, 0, 0, 0.1);
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--dark);
      color: var(--text);
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.3s, color 0.3s;
    }

    /* --- Scrollbar --- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    .light-theme::-webkit-scrollbar-thumb { background: #ccc; }

    /* Sidebar Styling */
    .sidebar {
      width: 280px;
      background: var(--card-bg);
      padding: 30px 0;
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: var(--transition);
      border-right: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .logo-container { padding: 0 20px 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
    .logo { display: flex; align-items: center; gap: 15px; font-size: 1.8rem; font-weight: 700; color: var(--text); }
    .logo i { color: var(--primary); background: rgba(67, 97, 238, 0.15); padding: 12px; border-radius: 12px; font-size: 1.2rem; }
    .sidebar nav { padding: 20px 0; display: flex; flex-direction: column; gap: 8px; flex-grow: 1; }
    .nav-link {
      display: flex; align-items: center; gap: 15px; color: var(--text-secondary); text-decoration: none;
      padding: 15px 25px; transition: var(--transition); font-size: 1.05rem; border-left: 4px solid transparent; position: relative;
    }
    .nav-link:hover, .nav-link.active {
      color: var(--text); border-left: 4px solid var(--primary); background: rgba(67, 97, 238, 0.1);
    }
    .nav-link i { width: 24px; text-align: center; font-size: 1.2rem; }
    .sidebar-footer { margin-top: auto; padding: 25px 25px 0; border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem; }
    .sidebar-footer p { margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .sidebar-footer i { color: var(--primary); }

    /* Main Content Area */
    .main-content { flex: 1; padding: 30px; display: flex; flex-direction: column; gap: 30px; overflow-y: auto; position: relative; }
    .page-view { display: none; }
    .page-view.active { display: block; }

    /* Header Styling */
    .header {
      display: flex; justify-content: space-between; align-items: center; padding: 25px;
      background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow);
    }
    .header-title h1 {
      font-size: 2rem; font-weight: 600; margin-bottom: 8px;
      background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header-title p { color: var(--text-secondary); font-size: 1.05rem; }

    /* Card Styling */
    .card {
      background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow);
      padding: 30px; transition: var(--transition); position: relative; border: 1px solid var(--border-color);
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); }
    .light-theme .card:hover { box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); }
    .card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);
    }
    .card-title { font-size: 1.4rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .card-title i { color: var(--primary); }

    /* --- General UI Elements --- */
    .button {
      padding: 12px 25px; background: var(--primary); border: none; border-radius: 8px; color: white;
      font-weight: 500; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 8px;
    }
    .button:hover { background: var(--primary-dark); transform: translateY(-2px); }
    .button:disabled { background: #555; cursor: not-allowed; transform: none; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); }
    .form-group input, .form-group select {
      width: 100%; padding: 10px; background: var(--dark); border: 1px solid var(--border-color);
      border-radius: 8px; color: var(--text);
    }
    .form-group input:disabled {
      background-color: #2a2a2a;
      color: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.7;
    }
    .light-theme .form-group input:disabled {
      background-color: var(--darker);
      color: var(--text-secondary);
    }

    /* Dashboard Specific */
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
    .mode-toggle { display: flex; background: var(--dark); border-radius: 50px; padding: 5px; margin-bottom: 20px; border: 1px solid var(--border-color); }
    .mode-btn { flex: 1; padding: 10px 15px; text-align: center; border-radius: 50px; cursor: pointer; transition: var(--transition); font-weight: 500; border: none; background: transparent; color: var(--text-secondary); }
    .mode-btn.active { background: var(--primary); color: var(--text); }
    .video-container { position: relative; border-radius: var(--border-radius); overflow: hidden; margin-bottom: 25px; background: #000; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); }
    .video-placeholder { color: var(--text-secondary); text-align: center; }
    .video-placeholder i { font-size: 4rem; margin-bottom: 1rem; }
    .video-container video, .video-container img { width: 100%; height: 100%; object-fit: cover; }
    .video-controls { display: flex; gap: 15px; margin-top: 20px; }
    .control-btn { flex: 1; padding: 15px 20px; background: rgba(255, 255, 255, 0.07); border: none; border-radius: 10px; color: var(--text); font-weight: 500; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px; }
    .light-theme .control-btn { background: rgba(0,0,0,0.05); }
    .control-btn:hover { transform: translateY(-3px); background: rgba(255,255,255,0.15); }
    .light-theme .control-btn:hover { background: rgba(0,0,0,0.1); }
    .control-btn.primary { background: var(--primary); color: white; }
    .control-btn.danger { background: var(--danger); color: white; }
    .control-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    #dropArea.dragover { background-color: rgba(67, 97, 238, 0.1); border-color: var(--primary); }
    .chart-container { height: 280px; margin-top: 25px; position: relative; }
    .alerts-container { max-height: 400px; overflow-y: auto; padding-right: 10px; }

    /* Alert Card & Log Styling */
    .alert-card { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; padding: 15px; border-radius: 12px; transition: opacity 0.3s ease, transform 0.3s ease; }
    .alert-card[data-video-time] { cursor: pointer; }
    .alert-card[data-video-time]:hover { background-color: rgba(67, 97, 238, 0.2); }
    .alert-card.critical { background: rgba(247, 37, 133, 0.1); border-left: 4px solid var(--danger); }
    .alert-card.warning { background: rgba(251, 146, 60, 0.1); border-left: 4px solid var(--warning); }
    .alert-card.info { background: rgba(76, 201, 240, 0.1); border-left: 4px solid var(--info); }
    .alert-icon { font-size: 1.5rem; }
    .alert-card.critical .alert-icon { color: var(--danger); }
    .alert-card.warning .alert-icon { color: var(--warning); }
    .alert-card.info .alert-icon { color: var(--info); }
    .alert-content h3 { font-size: 1.1rem; margin: 0; font-weight: 500; }
    .alert-content p { color: var(--text-secondary); font-size: 0.9rem; margin: 0; }
    .alert-close { margin-left: auto; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; transition: var(--transition); z-index: 5; }
    .alert-close:hover { color: var(--text); transform: rotate(90deg); }

    /* Cameras View */
    .cameras-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; }
    .camera-card { padding: 25px; cursor: grab; transition: all 0.4s ease; }
    .camera-card.dragging { opacity: 0.4; cursor: grabbing; transform: scale(0.98); }
    .camera-card.alert { border-color: var(--danger) !important; box-shadow: 0 0 25px var(--danger) !important; }
    .camera-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .camera-title { font-weight: 600; font-size: 1.3rem; }
    .camera-status { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; background: var(--dark); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--border-color); }
    .camera-status .status-indicator { width: 8px; height: 8px; border-radius: 50%; background: #666; transition: background 0.3s; }
    .camera-status.streaming .status-indicator { background: var(--success); animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .camera-feed { height: 220px; }
    .camera-stream-controls { margin-top: 15px; }
    .camera-stream-controls .url-input { width: 100%; padding: 10px; background: var(--dark); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text); margin-bottom: 10px; }
    .camera-graph { height: 80px; margin-top: 20px; }

    /* History & Alerts Page */
    .log-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .log-table th, .log-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
    .log-table th { color: var(--text-secondary); font-weight: 500; }
    .log-table .status-pill { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
    .log-table .status-critical { background: rgba(247, 37, 133, 0.2); color: var(--danger); }
    .log-table .status-pending { background: rgba(251, 146, 60, 0.2); color: var(--warning); }
    .log-table .status-recorded { background: rgba(74, 222, 128, 0.2); color: var(--success); }

    /* Settings Page */
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
    .toggle-switch { display: flex; align-items: center; justify-content: space-between; }
    .toggle-switch label { margin: 0; }
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .light-theme .slider { background-color: #ddd; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }
    
    /* --- Right-hand Video Sidebar --- */
    #video-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 340px;
      height: 100vh;
      background-color: var(--darker);
      border-left: 1px solid var(--border-color);
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 999;
      display: flex;
      flex-direction: column;
      display: none; /* Hidden by default, shown via JS only on dashboard */
    }
    #video-sidebar.is-open {
      transform: translateX(0);
      box-shadow: -10px 0 30px rgba(0,0,0,0.3);
    }
    #video-sidebar-toggle {
      position: absolute;
      top: 50%;
      left: -40px;
      transform: translateY(-50%);
      width: 40px;
      height: 70px;
      background: var(--darker);
      color: var(--text);
      border: 1px solid var(--border-color);
      border-right: none;
      border-radius: 10px 0 0 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: background-color 0.3s;
    }
    #video-sidebar-toggle:hover { background-color: var(--card-bg); }
    #video-sidebar-toggle i { transition: transform 0.4s; }
    #video-sidebar.is-open #video-sidebar-toggle i { transform: rotate(180deg); }
    #video-sidebar-header {
      padding: 20px;
      font-size: 1.3rem;
      font-weight: 600;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    #preselected-videos-list {
      list-style: none;
      padding: 10px;
      overflow-y: auto;
      flex-grow: 1;
    }
    .video-list-item {
      display: flex;
      gap: 15px;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .video-list-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    .video-list-item-thumb {
      width: 120px;
      height: 68px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      flex-shrink: 0;
      background-color: var(--dark);
    }
    .video-list-item-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .video-list-item-title {
      font-weight: 500;
      font-size: 0.95rem;
      line-height: 1.3;
      color: var(--text);
    }
    .video-list-item-duration {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* Authentication Styles */
    .auth-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: var(--dark);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .auth-background {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .auth-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 40px;
      width: 100%;
      max-width: 420px;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .auth-form {
      display: none;
    }

    .auth-form.active-form {
      display: block;
    }

    .auth-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .auth-header .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 20px;
    }

    .auth-header .logo i {
      color: var(--primary);
      background: rgba(67, 97, 238, 0.15);
      padding: 12px;
      border-radius: 12px;
      font-size: 1.2rem;
    }

    .auth-header h2 {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 8px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .auth-header p {
      color: var(--text-secondary);
      font-size: 1.05rem;
    }

    .auth-button {
      width: 100%;
      padding: 15px 25px;
      font-size: 1.1rem;
      margin-bottom: 20px;
    }

    .auth-footer {
      text-align: center;
      color: var(--text-secondary);
    }

    .auth-footer a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
    }

    .auth-footer a:hover {
      color: var(--secondary);
      text-decoration: underline;
    }

    .auth-loading {
      display: none;
      text-align: center;
      padding: 40px 20px;
    }

    .auth-loading.active-form {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .auth-theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }

    .theme-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: var(--text);
    }

    .theme-btn.active-theme {
      background: var(--primary);
      color: white;
    }

    .auth-message {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .auth-error {
      background: rgba(247, 37, 133, 0.1);
      border: 1px solid var(--danger);
      color: var(--danger);
    }

    .auth-success {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .main-application {
      width: 100%;
      min-height: 100vh;
      display: flex;
    }

    /* Responsive Adjustments */
    @media (max-width: 1400px) { .dashboard-grid, .cameras-grid, .settings-grid { grid-template-columns: 1fr; } }
    @media (max-width: 992px) { .sidebar { width: 80px; } .sidebar .logo span, .sidebar .nav-link span, .sidebar-footer { display: none; } .nav-link { justify-content: center; } #video-sidebar { width: 280px; } }
    @media (max-width: 768px) { body { flex-direction: column; } .sidebar { width: 100%; flex-direction: row; padding: 15px; justify-content: space-between; height: auto; } .logo-container, .sidebar nav span, .sidebar-footer { display: none; } .sidebar nav { flex-direction: row; padding: 0; } .header { flex-direction: column; gap: 20px; text-align: center; } }
  </style>
</head>
<body>
  <!-- Authentication Overlay -->
  <div id="auth-container" class="auth-container">
    <div class="auth-background">
      <div class="auth-card">
        <!-- Login Form -->
        <div id="login-form" class="auth-form active-form">
          <div class="auth-header">
            <div class="logo">
              <i class="fas fa-shield-halved"></i>
              <span>Avertix</span>
            </div>
            <h2>Welcome Back</h2>
            <p>Sign in to your account to continue</p>
          </div>
          
          <form id="login-form-element">
            <div class="form-group">
              <label for="login-username">Username</label>
              <input type="text" id="login-username" name="username" required>
            </div>
            
            <div class="form-group">
              <label for="login-password">Password</label>
              <input type="password" id="login-password" name="password" required>
            </div>
            
            <button type="submit" class="button auth-button" id="login-btn">
              <i class="fas fa-sign-in-alt"></i>
              Sign In
            </button>
          </form>
          
          <div class="auth-footer">
            <p>Don't have an account? <a href="#" id="show-register">Sign up here</a></p>
          </div>
        </div>

        <!-- Registration Form -->
        <div id="register-form" class="auth-form">
          <div class="auth-header">
            <div class="logo">
              <i class="fas fa-shield-halved"></i>
              <span>Avertix</span>
            </div>
            <h2>Create Account</h2>
            <p>Join Avertix to start monitoring</p>
          </div>
          
          <form id="register-form-element">
            <div class="form-group">
              <label for="register-username">Username</label>
              <input type="text" id="register-username" name="username" required>
            </div>
            
            <div class="form-group">
              <label for="register-password">Password</label>
              <input type="password" id="register-password" name="password" required>
            </div>
            
            <div class="form-group">
              <label for="register-confirm-password">Confirm Password</label>
              <input type="password" id="register-confirm-password" name="confirmPassword" required>
            </div>
            
            <button type="submit" class="button auth-button" id="register-btn">
              <i class="fas fa-user-plus"></i>
              Create Account
            </button>
          </form>
          
          <div class="auth-footer">
            <p>Already have an account? <a href="#" id="show-login">Sign in here</a></p>
          </div>
        </div>

        <!-- Loading State -->
        <div id="auth-loading" class="auth-loading">
          <div class="spinner"></div>
          <p>Please wait...</p>
        </div>

        <!-- Theme Toggle for Auth -->
        <div class="auth-theme-toggle">
          <button id="auth-theme-dark-btn" class="theme-btn active-theme">
            <i class="fas fa-moon"></i>
          </button>
          <button id="auth-theme-light-btn" class="theme-btn">
            <i class="fas fa-sun"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Application (hidden until authenticated) -->
  <div id="main-application" class="main-application" style="display: none;">
  <div class="sidebar">
    <div class="logo-container"><div class="logo"><i class="fas fa-shield-halved"></i><span>Avertix</span></div></div>
    <nav>
      <a href="#" class="nav-link active" data-view="dashboard-view"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
      <a href="#" class="nav-link" data-view="cameras-view"><i class="fas fa-video"></i><span>Cameras</span></a>
      <a href="#" class="nav-link" data-view="history-view"><i class="fas fa-history"></i><span>History</span></a>
      <a href="#" class="nav-link" data-view="alerts-view"><i class="fas fa-bell"></i><span>Alerts</span></a>
      <a href="#" class="nav-link" data-view="settings-view"><i class="fas fa-cog"></i><span>Settings</span></a>
    </nav>
    <div class="sidebar-footer">
      <p><i class="fas fa-building"></i> Managed by: Myteam.ai</p>
      <p><i class="fas fa-code-branch"></i> Version: 3.2.7 (Local-Only Sidebar)</p>
    </div>
  </div>

  <main class="main-content">
    <!-- Dashboard View -->
    <div id="dashboard-view" class="page-view active">
      <div class="header"><div class="header-title"><h1>System Dashboard</h1><p>demo</p><p>Unified analysis. Try our <a href="#" id="open-sidebar-link" class="text-secondary hover:underline">test videos</a>.</p></div></div>
      <div class="card">
        <div class="card-header"><h2 class="card-title"><i class="fas fa-cogs"></i> Detection Interface</h2></div>
        <div class="mode-toggle">
          <button class="mode-btn active" data-mode="offline">Realtime Processing</button>
        </div>
        <div id="offlineSection">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <!-- Left Column: Video Player -->
                <div>
                    <div class="video-container !mb-0" id="dropArea">
                        <video id="offlineVideo" controls style="display:none;"></video>
                        <div class="video-placeholder" id="offlinePlaceholder">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & Drop or Upload a Video File</p>
                        </div>
                    </div>
                    <input type="file" id="videoFile" accept="video/*" style="display: none;">
                </div>

                <!-- Right Column: Controls -->
                <div>
                    <div class="grid grid-cols-1 gap-y-8">
                         <div>
                            <label class="block mb-2 font-medium text-gray-300">Upload a Video File</label>
                            <div class="flex gap-2">
                                <button class="control-btn w-full" id="browseBtn"><i class="fas fa-folder-open"></i> Browse</button>
                                <button class="control-btn primary w-full" id="analyzeFileBtn" disabled><i class="fas fa-cogs"></i> Analyze File</button>
                            </div>
                        </div>
                        <div style="display:none;">
                            <label for="youtubeUrlOfflineInput" class="block mb-2 font-medium text-gray-300">...Or Analyze a YouTube Video</label>
                             <div class="flex gap-2">
                                <input type="url" id="youtubeUrlOfflineInput" placeholder="https://www.youtube.com/watch?v=..." class="w-full p-3 rounded-lg text-white" style="background: var(--dark); border: 1px solid var(--border-color);">
                                <button class="button" id="analyzeUrlOfflineBtn"><i class="fab fa-youtube"></i> Analyze</button>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>
      <div class="dashboard-grid">
        <div class="card"><div class="card-header"><h2 class="card-title"><i class="fas fa-chart-line"></i> Analysis Chart</h2></div><div class="chart-container"><canvas id="mainChart"></canvas></div></div>
        <div class="card"><div class="card-header"><h2 class="card-title"><i class="fas fa-exclamation-triangle"></i> Recent Alerts</h2></div><div id="alertsContainer" class="alerts-container"></div></div>
      </div>
    </div>

    <!-- Cameras View -->
    <div id="cameras-view" class="page-view"><div class="header"><div class="header-title"><h1>Multi-Camera Surveillance</h1><p>Drag to reorder. High-threat feeds are prioritized.</p></div></div><div class="cameras-grid" id="cameras-grid"></div></div>

    <!-- History View -->
    <div id="history-view" class="page-view">
      <div class="header"><div class="header-title"><h1>Event History</h1><p>A log of all recorded critical threat events.</p></div></div>
      <div class="card">
        <div class="card-header"><h2 class="card-title"><i class="fas fa-history"></i> Critical Events Log</h2></div>
        <div class="flex justify-between mb-4">
          <div class="relative">
            <input type="text" id="history-search" class="pl-10 pr-4 py-2 rounded-lg bg-gray-800 text-white border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search events...">
            <i class="fas fa-search absolute left-3 top-3 text-gray-500"></i>
          </div>
          <button id="clear-history-btn" class="button bg-red-600 hover:bg-red-700 flex items-center gap-2">
            <i class="fas fa-trash-alt"></i> Clear History
          </button>
        </div>
        <div style="overflow-x: auto;">
          <table class="log-table">
            <thead><tr><th>Camera</th><th>Threat Level</th><th>Timestamp</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="history-log-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Alerts View -->
    <div id="alerts-view" class="page-view">
      <div class="header"><div class="header-title"><h1>Alerts Management</h1><p>Review and filter all system alerts.</p></div></div>
      <div class="card">
        <div class="card-header"><h2 class="card-title"><i class="fas fa-filter"></i> Filter Alerts</h2></div>
        <div class="dashboard-grid">
            <div class="form-group"><label for="filter-severity">Severity</label><select id="filter-severity"><option value="all">All</option><option value="critical">Critical</option><option value="warning">Warning</option><option value="info">Info</option></select></div>
            <div class="form-group"><label for="filter-date-start">Start Date</label><input type="date" id="filter-date-start"></div>
            <div class="form-group"><label for="filter-date-end">End Date</label><input type="date" id="filter-date-end"></div>
        </div>
        <button class="button" id="apply-filters-btn">Apply Filters</button>
      </div>
      <div class="card">
        <div class="card-header"><h2 class="card-title"><i class="fas fa-bell"></i> Filtered Alerts Log</h2></div>
        <div id="full-alerts-log" class="alerts-container"></div>
      </div>
    </div>

    <!-- Settings View -->
    <div id="settings-view" class="page-view">
      <div class="header"><div class="header-title"><h1>System Settings</h1><p>Configure Avertix to your needs.</p></div></div>
      <div class="settings-grid">
        <div class="card">
            <div class="card-header"><h2 class="card-title"><i class="fas fa-cogs"></i> General</h2></div>
            <div class="form-group">
                <label for="alert-threshold-slider">Alert Sensitivity Threshold: <span id="threshold-value">75</span>%</label>
                <input type="range" min="0" max="100" value="75" id="alert-threshold-slider">
            </div>
            <div class="form-group toggle-switch">
                <label>Email Notifications</label>
                <label class="switch"><input type="checkbox" checked><span class="slider"></span></label>
            </div>
            <div class="form-group toggle-switch">
                <label>SMS Notifications</label>
                <label class="switch"><input type="checkbox"><span class="slider"></span></label>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h2 class="card-title"><i class="fas fa-palette"></i> Appearance</h2></div>
            <div class="form-group">
                <label>Theme</label>
                <div class="video-controls">
                    <button class="control-btn" id="theme-dark-btn"><i class="fas fa-moon"></i> Dark</button>
                    <button class="control-btn" id="theme-light-btn"><i class="fas fa-sun"></i> Light</button>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h2 class="card-title"><i class="fas fa-user"></i> User Profile</h2></div>
            <div class="form-group"><label>Username</label><input type="text" id="current-username" value="Admin" disabled></div>
            <div class="form-group"><label>Last Login</label><input type="text" id="current-last-login" value="Loading..." disabled></div>
            <div class="video-controls">
              <button class="button control-btn" id="change-password-btn" disabled>Change Password</button>
              <button class="button control-btn danger" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                Logout
              </button>
            </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Right-hand Video Sidebar -->
  <div id="video-sidebar">
      <button id="video-sidebar-toggle"><i class="fas fa-chevron-left"></i></button>
      <div id="video-sidebar-header">Test Videos</div>
      <ul id="preselected-videos-list">
          <!-- Video items will be populated here by JavaScript -->
      </ul>
  </div>

  </div> <!-- Close main-application div -->

  <script>
    document.addEventListener('DOMContentLoaded', () => {

    // --- RING BUFFER RECORDER ---
    function createRingBufferRecorder(stream, onClipReady, config) {
        if (!stream || !stream.active || typeof MediaRecorder === 'undefined') {
            console.warn("Stream is not active or MediaRecorder is not supported. Cannot create recorder.");
            return null;
        }
        let mediaRecorder;
        const mimeType = ['video/webm;codecs=vp9,opus', 'video/webm;codecs=vp8,opus', 'video/webm'].find(t => MediaRecorder.isTypeSupported(t));
        if (!mimeType) {
            console.error("No supported MIME type for MediaRecorder found.");
            return null;
        }
        let chunks = [], isAlertActive = false, endOfAlertTimeoutId = null, associatedEventId = null;
        try {
            mediaRecorder = new MediaRecorder(stream, { mimeType });
        } catch (e) {
            console.error("Failed to create MediaRecorder:", e);
            return null;
        }
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                chunks.push(event.data);
                if (!isAlertActive) {
                    const maxChunks = config.CLIP_PRE_ALERT_SECONDS;
                    while (chunks.length > maxChunks) {
                        chunks.shift();
                    }
                }
            }
        };
        const finalizeClip = () => {
            if (mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        };
        mediaRecorder.onstop = () => {
            if (chunks.length > 0 && associatedEventId !== null) {
                const clipBlob = new Blob(chunks, { type: mimeType });
                onClipReady(clipBlob, associatedEventId);
            }
            chunks = []; isAlertActive = false; associatedEventId = null;
            if (endOfAlertTimeoutId) clearTimeout(endOfAlertTimeoutId);
            endOfAlertTimeoutId = null;
            if (stream.active && mediaRecorder.state === 'inactive') {
                mediaRecorder.start(config.RECORDER_TIMESLICE);
            }
        };
        const start = () => {
            if (mediaRecorder && mediaRecorder.state === 'inactive') {
                chunks = [];
                mediaRecorder.start(config.RECORDER_TIMESLICE);
            }
        };
        const stop = () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                mediaRecorder.stop();
            }
            if (endOfAlertTimeoutId) clearTimeout(endOfAlertTimeoutId);
        };
        const triggerAlert = (eventId) => {
            if (!mediaRecorder || mediaRecorder.state !== 'recording') return;
            if (!isAlertActive) {
                isAlertActive = true;
                associatedEventId = eventId;
            }
            if (endOfAlertTimeoutId) {
                clearTimeout(endOfAlertTimeoutId);
                endOfAlertTimeoutId = null;
            }
        };
        const signalNormalcy = () => {
            if (isAlertActive && !endOfAlertTimeoutId) {
                endOfAlertTimeoutId = setTimeout(() => {
                    finalizeClip();
                }, 2000);
            }
        };
        return { start, stop, triggerAlert, signalNormalcy };
    }
        
    // --- CONFIGURATION FOR PRESELECTED LOCAL VIDEOS ---
    const PRESELECTED_VIDEOS = [
        { 
          name: "Eric Dier vs. Fan", 
          duration: "0:11",
          thumbnailUrl: "assets/th.JPG",
          videoPath: "/home/ubuntu/violence_detection/violence_detection/Avertix_Auth/frontend/assets/Eric Dier punching a bully fan (Spurs vs. Norwich).mp4",
        },
        { 
          name: "Fans celebrating", 
          duration: "0:12",
          thumbnailUrl: "assets/th2.JPG",
          videoPath: "/home/ubuntu/violence_detection/violence_detection/Avertix_Auth/frontend/assets/another_fan_video.mp4",
        },
        { 
          name: "Projectiles and disaster", 
          duration: "0:05",
          thumbnailUrl: "assets/th3.JPG",
          videoPath: "/home/ubuntu/violence_detection/violence_detection/Avertix_Auth/frontend/assets/14.mp4",
        },
        { 
          name: "Fans fight outside of stadium", 
          duration: "0:20",
          thumbnailUrl: "assets/th4.JPG",
          videoPath: "/home/ubuntu/violence_detection/violence_detection/Avertix_Auth/frontend/assets/1.mp4",
        },
        { 
          name: "Fans Celebrating with a LOT of passion", 
          duration: "0:18",
          thumbnailUrl: "assets/th5.JPG",
          videoPath: "/home/ubuntu/violence_detection/violence_detection/Avertix_Auth/frontend/assets/Fans Celebration in Unison.mp4",
        },
        { 
          name: "Fight between Cops and Supporters", 
          duration: "0:06",
          thumbnailUrl: "assets/th6.JPG",
          videoPath: "/home/ubuntu/violence_detection/violence_detection/Avertix_Auth/frontend/assets/Football Violence Uncovered - Fights, Camera, Action - S02 EP01 - Action Documentary_36-53_37-30.mp4",
        },
    ];
        
    const CONFIG = {
        API_ENDPOINTS: {
            REALTIME_FRAME: '/realtime-frame/',
            ANALYZE_UPLOAD: '/analyze-upload/',
            ANALYZE_YOUTUBE_OFFLINE: '/analyze-youtube-offline/',
            ANALYZE_LOCAL_FILE: '/analyze-local-file/',
            REALTIME_CAM: '/realtime-cam',
            PROXY: '/proxy/',
            KINESIS_STREAM: '/kinesis-stream',
            STREAM_START: '/stream/start',
            STREAM_STOP: '/stream/stop',
            STREAM_FEED: '/stream/feed',
            STREAM_STATUS: '/stream/status'
        },
        STREAM_FPS: 5,
        ALERT_DURATION: 10000,
        CRITICAL_ALERT_THROTTLE_MS: 5000,
        CAMERA_CHART_POINTS: 20,
        CLIP_PRE_ALERT_SECONDS: 2,
        RECORDER_TIMESLICE: 1000,
    };

    const state = {
        activeView: 'dashboard-view', activeDashboardMode: 'offline',
        settings: { alertThreshold: 75 },
        cameras: Array.from({ length: 10 }, (_, i) => ({
            id: i + 1,
            name: ['Main Entrance', 'Parking Lot A', 'Lobby', 'Corridor B', 'Rooftop Access', 'Service Elevator', 'East Stairwell', 'Loading Bay', 'Parking Lot B', 'West Perimeter'][i],
            prob: 0, isStreaming: false, url: '',
            chart: null, chartData: Array(CONFIG.CAMERA_CHART_POINTS).fill(0),
            analysisInterval: null, canvas: null, ctx: null,
            lastAlertTimestamp: 0, recorder: null
        })),
        allAlerts: [], eventHistory: [], draggedElement: null, isWebcamStreaming: false,
        dashboardWebcamLastAlert: 0, dashboardWebcamRecorder: null, isYouTubeStreaming: false
    };

    state.cameras[0].url = '';
    state.cameras[3].url = '';
    state.cameras[1].url = '';

      const elements = {
        body: document.body,
        views: { dashboard: document.getElementById('dashboard-view'), cameras: document.getElementById('cameras-view'), history: document.getElementById('history-view'), alerts: document.getElementById('alerts-view'), settings: document.getElementById('settings-view') },
        navLinks: document.querySelectorAll('.nav-link'),
        modeToggleButtons: document.querySelectorAll('.mode-btn'), realtimeSection: document.getElementById('realtimeSection'), offlineSection: document.getElementById('offlineSection'),
        realtimeVideo: document.getElementById('realtimeVideo'), realtimeVideoPlaceholder: document.getElementById('realtimeVideoPlaceholder'), startRealtimeBtn: document.getElementById('startRealtimeBtn'), stopRealtimeBtn: document.getElementById('stopRealtimeBtn'),
        realtimeStreamFeed: document.getElementById('realtimeStreamFeed'),
        dropArea: document.getElementById('dropArea'), offlineVideo: document.getElementById('offlineVideo'), offlinePlaceholder: document.getElementById('offlinePlaceholder'),
        videoFileInput: document.getElementById('videoFile'), browseBtn: document.getElementById('browseBtn'), analyzeFileBtn: document.getElementById('analyzeFileBtn'),
        youtubeUrlInput: document.getElementById('youtubeUrlInput'), analyzeUrlBtn: document.getElementById('analyzeUrlBtn'),
        youtubeUrlOfflineInput: document.getElementById('youtubeUrlOfflineInput'),
        analyzeUrlOfflineBtn: document.getElementById('analyzeUrlOfflineBtn'),
        mainChartCtx: document.getElementById('mainChart').getContext('2d'), alertsContainer: document.getElementById('alertsContainer'),
        camerasGrid: document.getElementById('cameras-grid'),
        historyLogBody: document.getElementById('history-log-body'),
        fullAlertsLog: document.getElementById('full-alerts-log'), filterSeverity: document.getElementById('filter-severity'),
        filterDateStart: document.getElementById('filter-date-start'), filterDateEnd: document.getElementById('filter-date-end'), applyFiltersBtn: document.getElementById('apply-filters-btn'),
        alertThresholdSlider: document.getElementById('alert-threshold-slider'), thresholdValue: document.getElementById('threshold-value'),
        themeDarkBtn: document.getElementById('theme-dark-btn'), themeLightBtn: document.getElementById('theme-light-btn'),
        clearHistoryBtn: document.getElementById('clear-history-btn'),
        historySearch: document.getElementById('history-search'),
        videoSidebar: document.getElementById('video-sidebar'),
        videoSidebarToggle: document.getElementById('video-sidebar-toggle'),
        preselectedVideosList: document.getElementById('preselected-videos-list'),
        openSidebarLink: document.getElementById('open-sidebar-link'),
      };

      let mainChart, dashboardWebcamCanvas, dashboardWebcamCtx, youtubeStatusInterval = null;
      let offlineAnalysisData = null;
      let offlineChartAnimationId = null;

      const clearMainChart = () => {
          if (mainChart) {
              mainChart.data.datasets[0].data = [];
              offlineAnalysisData = null;
              mainChart.update('none');
          }
      };

      const createMainChart = () => {
        if (mainChart) mainChart.destroy();
        const isRealtime = state.activeDashboardMode === 'realtime';
        mainChart = new Chart(elements.mainChartCtx, {
            type: 'line',
            data: { datasets: [{ label: 'Violence Probability', data: [], borderColor: '#f78aae', backgroundColor: 'rgba(247, 138, 174, 0.2)', borderWidth: 2.5, tension: 0.4, fill: true, pointRadius: 0 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                parsing: { xAxisKey: 'x', yAxisKey: 'y' },
                onClick: (event, elementsArray) => {
                    if (!isRealtime && elementsArray.length > 0 && elements.offlineVideo.src) {
                        const dataPoint = mainChart.data.datasets[0].data[elementsArray[0].index];
                        if (dataPoint?.x !== undefined) { elements.offlineVideo.currentTime = dataPoint.x; elements.offlineVideo.play(); }
                    }
                },
                plugins: { legend: { display: false }, tooltip: { callbacks: { title: (items) => isRealtime ? new Date(items[0].raw.x).toLocaleString() : `Time: ${new Date(items[0].raw.x * 1000).toISOString().substr(14, 5)}` } } },
                scales: {
                    y: { min: 0, max: 100, ticks: { color: getComputedStyle(elements.body).getPropertyValue('--text'), callback: v => `${v}%` }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                    x: isRealtime ? { type: 'time', time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } }, ticks: { color: getComputedStyle(elements.body).getPropertyValue('--text-secondary'), maxTicksLimit: 8, autoSkip: true }, grid: { display: false } } : { type: 'linear', ticks: { color: getComputedStyle(elements.body).getPropertyValue('--text-secondary'), maxTicksLimit: 10, callback: value => new Date(value * 1000).toISOString().substr(14, 5) }, grid: { color: 'rgba(255, 255, 255, 0.05)' } }
                },
                animation: { duration: 0 }
            }
        });
      };
      
      const switchView = (viewId) => { 
        state.activeView = viewId; 
        document.querySelectorAll('.page-view').forEach(v => v.classList.remove('active')); 
        document.getElementById(viewId).classList.add('active'); 
        elements.navLinks.forEach(l => l.classList.toggle('active', l.dataset.view === viewId)); 
        elements.videoSidebar.style.display = (viewId === 'dashboard-view') ? 'flex' : 'none';
        if (viewId !== 'dashboard-view') toggleVideoSidebar(false);
        if (viewId === 'cameras-view') renderCameraCards(); 
        if (viewId === 'history-view') renderHistoryLog(); 
        if (viewId === 'alerts-view') renderAlertsLog(); 
      };
      
      const switchDashboardMode = (mode) => {
          if (state.activeDashboardMode === mode) return;
          state.activeDashboardMode = mode;
          elements.modeToggleButtons.forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
          if (elements.realtimeSection) elements.realtimeSection.style.display = mode === 'realtime' ? 'block' : 'none';
          if (elements.offlineSection) elements.offlineSection.style.display = mode === 'offline' ? 'block' : 'none';
          if (state.isWebcamStreaming) stopRealtime();
          if (state.isYouTubeStreaming) stopYouTubeStream();
          offlineAnalysisData = null;
          if (offlineChartAnimationId) cancelAnimationFrame(offlineChartAnimationId);
          createMainChart();
      };

      const showAlert = (message, type = 'warning', source = 'System', options = {}) => {
        const alertData = { id: `alert-${Date.now()}`, message, type, source, timestamp: new Date(), ...options };
        state.allAlerts.unshift(alertData);
        const alertCard = document.createElement('div');
        alertCard.className = `alert-card ${type}`;
        alertCard.innerHTML = `<div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="alert-content"><h3>${source}</h3><p>${message}</p></div><button class="alert-close"><i class="fas fa-times"></i></button>`;
        if (options.videoTime !== undefined) {
            alertCard.dataset.videoTime = options.videoTime;
        }
        if (elements.alertsContainer.childElementCount < 5) { elements.alertsContainer.prepend(alertCard); }
        const removeAlert = () => { alertCard.style.opacity = '0'; alertCard.style.transform = 'translateX(20px)'; setTimeout(() => alertCard.remove(), 300); };
        alertCard.querySelector('.alert-close').addEventListener('click', (e) => { e.stopPropagation(); removeAlert(); });
        setTimeout(removeAlert, CONFIG.ALERT_DURATION);
      };
      
      const toggleVideoSidebar = (forceOpen = null) => {
          const isOpen = elements.videoSidebar.classList.contains('is-open');
          if (forceOpen === true) { if (!isOpen) elements.videoSidebar.classList.add('is-open'); } 
          else if (forceOpen === false) { if (isOpen) elements.videoSidebar.classList.remove('is-open'); }
          else { elements.videoSidebar.classList.toggle('is-open'); }
      };

      const populatePreselectedVideos = () => {
          if (PRESELECTED_VIDEOS.length === 0) {
              elements.preselectedVideosList.innerHTML = `<li class="p-4 text-center text-gray-500">No test videos configured.</li>`;
              return;
          }
          const placeholderThumbnail = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzQ0NCI+PHBhdGggZD0iTTE3IDEwLjVWN2MwLS41NS0uNDUtMS0xLTFINGMtLjU1IDAtMSAuNDUgMCAxMWMwIC41NS40NSAxIDEgMWgxMmMuNTUgMCAxLS40NSAxLTF2LTMuNWw0IDR2LTExbC00IDR6Ii8+PC9zdmc+";
          elements.preselectedVideosList.innerHTML = PRESELECTED_VIDEOS.map((video, index) => `
              <li class="video-list-item" data-index="${index}">
                  <img src="${video.thumbnailUrl}" alt="${video.name}" class="video-list-item-thumb" onerror="this.onerror=null;this.src='${placeholderThumbnail}'">
                  <div class="video-list-item-info">
                      <h4 class="video-list-item-title">${video.name}</h4>
                      <span class="video-list-item-duration">${video.duration}</span>
                  </div>
              </li>`).join('');
      };
      
      const loadPreselectedVideo = async (index) => {
          const videoData = PRESELECTED_VIDEOS[index];
          if (!videoData) return;

          clearMainChart(); // Clear the chart immediately when a new video is chosen.
          
          if (state.activeDashboardMode !== 'offline') switchDashboardMode('offline');
          
          showAlert(`Analyzing sidebar video: '${videoData.name}'...`, 'info');
          await analyzeLocalFile(videoData.videoPath);
      };
      
      const renderHistoryLog = () => {
        const searchTerm = elements.historySearch.value.toLowerCase();
        const filteredHistory = state.eventHistory.filter(event => event.cameraName.toLowerCase().includes(searchTerm) || event.prob.toString().includes(searchTerm) || event.timestamp.toLocaleString().toLowerCase().includes(searchTerm));
        elements.historyLogBody.innerHTML = filteredHistory.map(event => `
          <tr>
            <td>${event.cameraName}</td>
            <td><span class="status-pill status-critical">${event.prob}%</span></td>
            <td>${event.timestamp.toLocaleString()}</td>
            <td><span class="status-pill status-${event.status}">${event.status.charAt(0).toUpperCase() + event.status.slice(1)}</span></td>
            <td>
              ${event.clipBlob ?
                `<button class="button" data-event-id="${event.id}" data-action="download"><i class="fas fa-download"></i> Download Clip</button>` :
                 (event.status === 'pending' ? `<span class="text-yellow-400 text-sm flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i> Clip en cours...</span>` : `<span class="text-gray-500 text-sm">Échec</span>`)
              }
            </td>
          </tr>
        `).join('') || `<tr><td colspan="5" style="text-align:center;">No critical events recorded yet.</td></tr>`;
      };
      const downloadClip = (blob, filename) => { const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = filename; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); a.remove(); };
      const clearHistory = () => { if (confirm('Are you sure you want to clear all event history? This action cannot be undone.')) { state.eventHistory = []; state.allAlerts = state.allAlerts.filter(a => a.type !== 'critical'); state.cameras.forEach(camera => { camera.lastAlertTimestamp = 0; }); state.dashboardWebcamLastAlert = 0; renderHistoryLog(); renderAlertsLog(); } };
      const renderAlertsLog = (alerts = state.allAlerts) => { elements.fullAlertsLog.innerHTML = alerts.map(alert => `<div class="alert-card ${alert.type}" ${alert.videoTime !== undefined ? `data-video-time="${alert.videoTime}"` : ''}><div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="alert-content"><h3>${alert.source} (${alert.type})</h3><p>${alert.message} - ${alert.timestamp.toLocaleTimeString()}</p></div></div>`).join('') || `<p style="text-align:center; color: var(--text-secondary);">No alerts to display.</p>`; };
      const renderCameraCards = () => { elements.camerasGrid.innerHTML = ''; state.cameras.forEach(cam => { const card = document.createElement('div'); card.className = 'camera-card card'; card.id = `cam-card-${cam.id}`; card.draggable = true; card.innerHTML = `<div class="camera-header"><h3 class="camera-title">${cam.name}</h3><div class="camera-status" id="status-cont-${cam.id}"><div class="status-indicator"></div><span id="status-text-${cam.id}">OFFLINE</span></div></div><div class="video-container camera-feed"><img id="img-feed-${cam.id}" src="" alt="Camera Feed" style="display:none;"><video id="video-feed-${cam.id}" autoplay muted playsinline style="display:none;"></video><div class="video-placeholder" id="placeholder-${cam.id}"><i class="fas fa-power-off"></i></div></div><div class="camera-stream-controls"><input type="text" class="url-input" id="url-input-${cam.id}" value="${cam.url}" placeholder="Enter HTTP Stream URL or KVS ARN"><div class="video-controls"><button class="control-btn" data-cam-id="${cam.id}" data-action="start"><i class="fas fa-play"></i> Start</button></div></div><div class="camera-graph"><canvas id="cam-chart-${cam.id}"></canvas></div>`; elements.camerasGrid.appendChild(card); const ctx = document.getElementById(`cam-chart-${cam.id}`).getContext('2d'); cam.chart = new Chart(ctx, { type: 'line', data: { labels: Array(CONFIG.CAMERA_CHART_POINTS).fill(''), datasets: [{ data: cam.chartData, borderColor: 'var(--secondary)', backgroundColor: 'rgba(76, 201, 240, 0.1)', borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false, min: 0, max: 100 }, x: { display: false } } } }); }); };
      const updateCameraUI = (cam, { prob, isStreaming, statusText }) => {
          const card = document.getElementById(`cam-card-${cam.id}`), statusCont = document.getElementById(`status-cont-${cam.id}`), statusTextEl = document.getElementById(`status-text-${cam.id}`), startBtn = card.querySelector('[data-action="start"],[data-action="stop"]'), imgFeed = document.getElementById(`img-feed-${cam.id}`), videoFeed = document.getElementById(`video-feed-${cam.id}`), placeholder = document.getElementById(`placeholder-${cam.id}`);
          if (prob !== undefined) { cam.prob = prob; cam.chartData.shift(); cam.chartData.push(prob); cam.chart.data.datasets[0].data = cam.chartData; cam.chart.update('none'); const isAlert = prob > state.settings.alertThreshold; card.classList.toggle('alert', isAlert); if (isAlert) prioritizeCamera(cam.id); }
          if (isStreaming !== undefined) { cam.isStreaming = isStreaming; statusCont.classList.toggle('streaming', isStreaming); startBtn.innerHTML = isStreaming ? `<i class="fas fa-stop"></i> Stop` : `<i class="fas fa-play"></i> Start`; startBtn.dataset.action = isStreaming ? 'stop' : 'start'; startBtn.classList.toggle('danger', isStreaming); placeholder.style.display = isStreaming ? 'none' : 'flex'; if (!isStreaming) { imgFeed.style.display = 'none'; videoFeed.style.display = 'none'; } }
          if (statusText !== undefined) statusTextEl.innerText = statusText;
      };
      const startHttpStream = async (cam) => {
          const urlInput = document.getElementById(`url-input-${cam.id}`); cam.url = urlInput.value.trim();
          if (!cam.url) return showAlert(`URL or ARN is missing for ${cam.name}.`, 'error', cam.name);
          updateCameraUI(cam, { isStreaming: true, statusText: 'CONNECTING' });
          const imgFeed = document.getElementById(`img-feed-${cam.id}`), videoFeed = document.getElementById(`video-feed-${cam.id}`);
          let feedElement, stream, isKinesis = cam.url.startsWith('arn:aws:kinesisvideo:');
          try {
              if (isKinesis) {
                  const response = await fetch(CONFIG.API_ENDPOINTS.KINESIS_STREAM, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ arn: cam.url }) });
                  if (!response.ok) throw new Error(`API Error ${response.status}`);
                  const { streamUrl } = await response.json(); videoFeed.style.display = 'block'; feedElement = videoFeed;
                  if (Hls.isSupported()) { const hls = new Hls(); hls.loadSource(streamUrl); hls.attachMedia(videoFeed); }
                  else if (videoFeed.canPlayType('application/vnd.apple.mpegurl')) { videoFeed.src = streamUrl; }
                  stream = videoFeed.captureStream();
              } else {
                  imgFeed.style.display = 'block'; feedElement = imgFeed; feedElement.src = `${CONFIG.API_ENDPOINTS.PROXY}?url=${encodeURIComponent(cam.url)}`;
                  if (!cam.canvas) { cam.canvas = document.createElement('canvas'); cam.canvas.width = 224; cam.canvas.height = 224; cam.ctx = cam.canvas.getContext('2d'); }
                  stream = cam.canvas.captureStream(CONFIG.STREAM_FPS);
              }
              const onClipReady = (blob, eventId) => { const event = state.eventHistory.find(e => e.id === eventId); if (event) { event.clipBlob = blob; event.status = 'recorded'; renderHistoryLog(); } };
              cam.recorder = createRingBufferRecorder(stream, onClipReady, CONFIG);
              if (cam.recorder) cam.recorder.start();
              updateCameraUI(cam, { statusText: 'STREAMING' });
              cam.analysisInterval = setInterval(async () => {
                  if (!cam.isStreaming) return;
                  cam.ctx.drawImage(feedElement, 0, 0, 224, 224);
                  const blob = await new Promise(resolve => cam.canvas.toBlob(resolve, 'image/jpeg', 0.8));
                  const b64 = await new Promise((resolve) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result.split(',')[1]); reader.readAsDataURL(blob); });
                  const resp = await fetch(CONFIG.API_ENDPOINTS.REALTIME_CAM, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ frame: b64, stream_id: cam.id }) });
                  if (!resp.ok) throw new Error(`Prediction API failed for ${cam.name}`);
                  const { prediction } = await resp.json();
                  const prob = prediction * 100;
                  updateCameraUI(cam, { prob });
                  if (prob > state.settings.alertThreshold) {
                      const now = Date.now();
                      if (now - cam.lastAlertTimestamp > CONFIG.CRITICAL_ALERT_THROTTLE_MS) {
                          cam.lastAlertTimestamp = now;
                          const newEvent = { id: now, cameraName: cam.name, prob: Math.round(prob), timestamp: new Date(), status: 'pending', cameraId: cam.id, clipBlob: null };
                          state.eventHistory.unshift(newEvent);
                          showAlert(`Critical threat detected: ${Math.round(prob)}%`, 'critical', cam.name);
                          renderHistoryLog();
                          if (cam.recorder) cam.recorder.triggerAlert(newEvent.id);
                      } else {
                          if (cam.recorder) cam.recorder.triggerAlert(null);
                      }
                  } else {
                      if (cam.recorder) cam.recorder.signalNormalcy();
                  }
              }, 1000 / CONFIG.STREAM_FPS);
          } catch (error) { showAlert(`Failed to start stream for ${cam.name}: ${error.message}`, 'error', cam.name); stopHttpStream(cam); }
      };
      const stopHttpStream = (cam) => { if (cam.recorder) { cam.recorder.stop(); cam.recorder = null; } clearInterval(cam.analysisInterval); cam.analysisInterval = null; if(cam.canvas) { cam.canvas.remove(); cam.canvas = null; cam.ctx = null; } document.getElementById(`img-feed-${cam.id}`).src = ''; document.getElementById(`video-feed-${cam.id}`).src = ''; updateCameraUI(cam, { isStreaming: false, statusText: 'OFFLINE', prob: 0 }); };
      const prioritizeCamera = (camId) => { const card = document.getElementById(`cam-card-${camId}`); if (elements.camerasGrid.firstChild.id !== card.id) { elements.camerasGrid.prepend(card); syncCameraStateOrder(); } };
      const syncCameraStateOrder = () => { state.cameras = Array.from(elements.camerasGrid.querySelectorAll('.camera-card')).map(card => state.cameras.find(c => c.id === parseInt(card.id.replace('cam-card-', '')))); };
      async function startRealtime() {
          if (state.isWebcamStreaming || state.isYouTubeStreaming) { showAlert('Another real-time stream is already active.', 'warning'); return; }
          state.isWebcamStreaming = true;
          elements.startRealtimeBtn.disabled = true; elements.stopRealtimeBtn.disabled = false;
          elements.youtubeUrlInput.disabled = true; elements.analyzeUrlBtn.disabled = true;
          elements.realtimeVideo.style.display = 'block'; elements.realtimeVideoPlaceholder.style.display = 'none';
          try {
              const stream = await navigator.mediaDevices.getUserMedia({ video: true });
              elements.realtimeVideo.srcObject = stream;
              const onClipReady = (blob, eventId) => { const event = state.eventHistory.find(e => e.id === eventId); if (event) { event.clipBlob = blob; event.status = 'recorded'; renderHistoryLog(); } };
              state.dashboardWebcamRecorder = createRingBufferRecorder(stream, onClipReady, CONFIG);
              if (state.dashboardWebcamRecorder) state.dashboardWebcamRecorder.start();
          } catch (err) { showAlert('Failed to access webcam: ' + err.message, 'error'); stopRealtime(); return; }
          dashboardWebcamCanvas = document.createElement('canvas'); dashboardWebcamCanvas.width = 224; dashboardWebcamCanvas.height = 224; dashboardWebcamCtx = dashboardWebcamCanvas.getContext('2d');
          createMainChart(); captureLoop();
      }
      function stopRealtime() {
          state.isWebcamStreaming = false;
          elements.startRealtimeBtn.disabled = false; elements.stopRealtimeBtn.disabled = true;
          elements.youtubeUrlInput.disabled = false; elements.analyzeUrlBtn.disabled = false;
          if (state.dashboardWebcamRecorder) { state.dashboardWebcamRecorder.stop(); state.dashboardWebcamRecorder = null; }
          if (elements.realtimeVideo.srcObject) { elements.realtimeVideo.srcObject.getTracks().forEach(t => t.stop()); elements.realtimeVideo.srcObject = null; }
          elements.realtimeVideo.style.display = 'none'; elements.realtimeVideoPlaceholder.style.display = 'block';
      }
      async function captureLoop() {
          if (!state.isWebcamStreaming) return;
          dashboardWebcamCtx.drawImage(elements.realtimeVideo, 0, 0, 224, 224);
          const blob = await new Promise(resolve => dashboardWebcamCanvas.toBlob(resolve, 'image/jpeg', 0.8));
          const b64 = await new Promise((resolve) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result.split(',')[1]); reader.readAsDataURL(blob); });
          try {
              const response = await fetch(CONFIG.API_ENDPOINTS.REALTIME_FRAME, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ frame: b64 }) });
              if (!response.ok) throw new Error(`API Error ${response.status}`);
              const { prediction } = await response.json(); const prob = prediction * 100;
              if (mainChart.data.datasets[0].data.length > 60) {
                 mainChart.data.datasets[0].data.shift();
              }
              mainChart.data.datasets[0].data.push({ x: Date.now(), y: prob });
              mainChart.update('none');
              if (prob > state.settings.alertThreshold) {
                  const now = Date.now();
                  if (now - state.dashboardWebcamLastAlert > CONFIG.CRITICAL_ALERT_THROTTLE_MS) {
                      state.dashboardWebcamLastAlert = now;
                      const newEvent = { id: now, cameraName: 'Dashboard Webcam', prob: Math.round(prob), timestamp: new Date(), status: 'pending', cameraId: 0, clipBlob: null };
                      state.eventHistory.unshift(newEvent);
                      showAlert(`Critical threat detected: ${Math.round(prob)}% at ${new Date().toLocaleTimeString()}`, 'critical', 'Dashboard Webcam');
                      renderHistoryLog();
                      if (state.dashboardWebcamRecorder) state.dashboardWebcamRecorder.triggerAlert(newEvent.id);
                  } else {
                       if (state.dashboardWebcamRecorder) state.dashboardWebcamRecorder.triggerAlert(null);
                  }
              } else {
                  if (state.dashboardWebcamRecorder) state.dashboardWebcamRecorder.signalNormalcy();
              }
          } catch (error) { console.error('Error in real-time prediction:', error); }
          setTimeout(captureLoop, 200);
      }
      
      const processOfflineResults = (data) => {
        createMainChart();
        const dataPoints = data.predictions.map((p, i) => ({ x: (i * 16) / data.fps, y: p * 100 }));
        offlineAnalysisData = dataPoints;
        mainChart.data.datasets[0].data = [];
        mainChart.options.scales.x.max = dataPoints.length > 0 ? dataPoints[dataPoints.length - 1].x : (elements.offlineVideo.duration || 1);
        mainChart.update();
        let lastAlertTime = -Infinity;
        dataPoints.forEach(point => {
            if (point.y > state.settings.alertThreshold && (point.x - lastAlertTime) > 5) {
                lastAlertTime = point.x;
                showAlert(`High probability event (${Math.round(point.y)}%) at ${new Date(point.x * 1000).toISOString().substr(14, 5)}`, 'critical', 'Offline Analysis', { videoTime: point.x });
            }
        });
        showAlert(`Analysis complete. Max probability: ${Math.round(Math.max(0, ...dataPoints.map(p => p.y)))}%`, 'info');
      };

      async function analyzeUploadedVideo() {
        const file = elements.videoFileInput.files[0]; if (!file) { showAlert('Please select a video file first', 'error'); return; }
        elements.analyzeFileBtn.disabled = true; elements.analyzeFileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        const formData = new FormData(); formData.append('file', file);
        try {
          const response = await fetch(CONFIG.API_ENDPOINTS.ANALYZE_UPLOAD, { method: 'POST', body: formData });
          if (!response.ok) throw new Error(`API Error ${response.status}`);
          const data = await response.json();
          processOfflineResults(data);
          elements.offlineVideo.play();
        } catch (error) { showAlert('Error analyzing video: ' + error.message, 'error'); }
         finally { elements.analyzeFileBtn.disabled = false; elements.analyzeFileBtn.innerHTML = '<i class="fas fa-cogs"></i> Analyze File'; }
      }
      
      async function commonOfflineAnalysis(endpoint, payload, sourceName) {
        const placeholder = elements.offlinePlaceholder;
        const btn = elements.analyzeUrlOfflineBtn;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        placeholder.innerHTML = `<i class="fas fa-spinner fa-spin text-4xl"></i><p class="mt-2">Analyzing ${sourceName}...</p>`;
        
        elements.offlineVideo.src = '';
        elements.offlineVideo.style.display = 'none';
        placeholder.style.display = 'flex';
        elements.videoFileInput.value = '';
        elements.analyzeFileBtn.disabled = true;

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `API Error ${response.status}`);
            }

            const data = await response.json();
            
            if (data.predictions && data.fps && data.video_url) {
                processOfflineResults(data);
                elements.offlineVideo.src = data.video_url;
                elements.offlineVideo.style.display = 'block';
                placeholder.style.display = 'none';
                elements.offlineVideo.play();
            } else {
                 throw new Error("Invalid response from server. Expected 'predictions', 'fps', and 'video_url'.");
            }
        } catch (error) {
            showAlert('Error analyzing video: ' + error.message, 'error');
            placeholder.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><p>Drag & Drop or Upload a Video File</p>';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fab fa-youtube"></i> Analyze';
        }
      }
      
      async function analyzeLocalFile(path) {
          if (!path) {
              showAlert('No local file path provided.', 'error');
              return;
          }
          await commonOfflineAnalysis(CONFIG.API_ENDPOINTS.ANALYZE_LOCAL_FILE, { path: path }, "Local File");
      }
      
      async function analyzeRemoteVideo(url) {
        if (!url) {
            showAlert('No video URL provided for analysis.', 'error');
            return;
        }
        await commonOfflineAnalysis(CONFIG.API_ENDPOINTS.ANALYZE_YOUTUBE_OFFLINE, { url: url }, "Remote Video");
      }

      async function analyzeYouTubeOffline() {
        const url = elements.youtubeUrlOfflineInput.value.trim();
        if (!url || !/(youtube\.com|youtu\.be)/.test(url)) {
            showAlert('Please enter a valid YouTube URL.', 'error');
            return;
        }
        await analyzeRemoteVideo(url);
      }
      
      function updateYouTubeBtn(isStreaming) {
        const btn = elements.analyzeUrlBtn;
        if (isStreaming) { btn.innerHTML = '<i class="fas fa-stop"></i> Stop'; btn.classList.add('bg-red-600', 'hover:bg-red-700'); btn.classList.remove('bg-primary', 'hover:bg-primary-dark'); }
        else { btn.innerHTML = '<i class="fab fa-youtube"></i> Analyze'; btn.classList.remove('bg-red-600', 'hover:bg-red-700'); btn.classList.add('bg-primary', 'hover:bg-primary-dark'); }
      }
      async function startYouTubeStream() {
        const url = elements.youtubeUrlInput.value.trim();
        if (state.isWebcamStreaming || state.isYouTubeStreaming) { showAlert('Another real-time stream is already active.', 'warning'); return; }
        if (!url || !/(youtube\.com|youtu\.be)/.test(url)) { showAlert('Please enter a valid YouTube URL.', 'error'); return; }
        state.isYouTubeStreaming = true;
        elements.startRealtimeBtn.disabled = true;
        elements.stopRealtimeBtn.disabled = true;
        updateYouTubeBtn(true);
        elements.realtimeVideo.style.display = 'none';
        elements.realtimeVideoPlaceholder.style.display = 'none';
        elements.realtimeStreamFeed.style.display = 'block';
        createMainChart();
        try {
            const payload = { source: url, modelConfig: { clip_size: 16, memory: 10, threshold: parseInt(state.settings.alertThreshold) || 75 } };
            const response = await fetch(CONFIG.API_ENDPOINTS.STREAM_START, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const errData = await response.json(); throw new Error(errData.detail || `API Error ${response.status}`); }
            elements.realtimeStreamFeed.src = CONFIG.API_ENDPOINTS.STREAM_FEED + '?t=' + new Date().getTime();
            if (youtubeStatusInterval) clearInterval(youtubeStatusInterval);
            youtubeStatusInterval = setInterval(pollYouTubeStatus, 1000);
        } catch (error) { showAlert(`Failed to start YouTube stream: ${error.message}`, 'error'); await stopYouTubeStream(); }
      }
      async function stopYouTubeStream() {
        if (youtubeStatusInterval) { clearInterval(youtubeStatusInterval); youtubeStatusInterval = null; }
        try { await fetch(CONFIG.API_ENDPOINTS.STREAM_STOP, { method: 'POST' }); }
        catch (error) { console.warn("Couldn't reach server to stop stream, but cleaning up UI anyway.", error); }
        state.isYouTubeStreaming = false;
        elements.startRealtimeBtn.disabled = false;
        elements.stopRealtimeBtn.disabled = true;
        updateYouTubeBtn(false);
        elements.realtimeStreamFeed.src = '';
        elements.realtimeStreamFeed.style.display = 'none';
        elements.realtimeVideoPlaceholder.style.display = 'block';
      }
      async function pollYouTubeStatus() {
        if (!state.isYouTubeStreaming) { if (youtubeStatusInterval) clearInterval(youtubeStatusInterval); return; }
        try {
            const response = await fetch(CONFIG.API_ENDPOINTS.STREAM_STATUS);
            if (!response.ok) throw new Error(`Status check failed: ${response.status}`);
            const status = await response.json();
            if (!status.is_active) { showAlert('YouTube stream ended on the server.', 'info'); await stopYouTubeStream(); return; }
            const prob = (status.last_prediction?.confidence || 0) * 100;
            if (mainChart.data.datasets[0].data.length > 60) {
                 mainChart.data.datasets[0].data.shift();
            }
            mainChart.data.datasets[0].data.push({ x: Date.now(), y: prob });
            mainChart.update('none');
            if (prob > state.settings.alertThreshold) {
                const now = Date.now();
                if (now - state.dashboardWebcamLastAlert > CONFIG.CRITICAL_ALERT_THROTTLE_MS) {
                    state.dashboardWebcamLastAlert = now;
                    showAlert(`Critical threat detected from YouTube stream: ${Math.round(prob)}% at ${new Date().toLocaleTimeString()}`, 'critical', 'YouTube Stream');
                }
            }
        } catch (error) {
            console.error('Error polling YouTube stream status:', error);
            showAlert('Lost connection to YouTube stream.', 'error');
            await stopYouTubeStream();
        }
      }
      function handleFileSelect(file) {
        if(file.type.startsWith('video/')){
            clearMainChart(); // Also clear the chart when a new local file is selected/dropped.
            const url = URL.createObjectURL(file);
            elements.offlineVideo.src = url;
            elements.offlineVideo.style.display='block';
            elements.offlinePlaceholder.style.display='none';
            elements.analyzeFileBtn.disabled=false;
        } else { showAlert('Invalid file type. Please upload a video.', 'error'); }
      }

      const animateOfflineChart = () => {
        if (state.activeDashboardMode !== 'offline' || !offlineAnalysisData || elements.offlineVideo.paused) {
            cancelAnimationFrame(offlineChartAnimationId);
            return;
        }
        const currentTime = elements.offlineVideo.currentTime;
        const visibleData = offlineAnalysisData.filter(p => p.x <= currentTime);
        if (mainChart.data.datasets[0].data.length !== visibleData.length) {
            mainChart.data.datasets[0].data = visibleData;
            mainChart.update('none');
        }
        offlineChartAnimationId = requestAnimationFrame(animateOfflineChart);
      };

      // --- EVENT LISTENERS ---
      elements.navLinks.forEach(l => l.addEventListener('click', (e) => { e.preventDefault(); switchView(l.dataset.view); }));
      elements.modeToggleButtons.forEach(b => b.addEventListener('click', () => switchDashboardMode(b.dataset.mode)));
      elements.camerasGrid.addEventListener('click', (e) => { const b = e.target.closest('button[data-cam-id]'); if (b) { const cam = state.cameras.find(c => c.id === parseInt(b.dataset.camId)); if (b.dataset.action === 'start') startHttpStream(cam); else stopHttpStream(cam); } });
      elements.camerasGrid.addEventListener('dragstart', e => { if (e.target.classList.contains('camera-card')) { state.draggedElement = e.target; e.target.classList.add('dragging'); } });
      elements.camerasGrid.addEventListener('dragend', e => { if (state.draggedElement) { state.draggedElement.classList.remove('dragging'); state.draggedElement = null; } });
      elements.camerasGrid.addEventListener('dragover', e => { e.preventDefault(); const afterElement = [...elements.camerasGrid.querySelectorAll('.camera-card:not(.dragging)')].reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = e.clientY - box.top - box.height / 2; return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest; }, { offset: Number.NEGATIVE_INFINITY }).element; if (afterElement == null) { elements.camerasGrid.appendChild(state.draggedElement); } else { elements.camerasGrid.insertBefore(state.draggedElement, afterElement); } });
      elements.camerasGrid.addEventListener('drop', e => { e.preventDefault(); if (state.draggedElement) syncCameraStateOrder(); });
      if (elements.startRealtimeBtn) elements.startRealtimeBtn.addEventListener('click', startRealtime);
      if (elements.stopRealtimeBtn) elements.stopRealtimeBtn.addEventListener('click', stopRealtime);
      elements.browseBtn.addEventListener('click', () => elements.videoFileInput.click());
      elements.videoFileInput.addEventListener('change', (e) => e.target.files.length && handleFileSelect(e.target.files[0]));
      elements.dropArea.addEventListener('dragover', (e) => { e.preventDefault(); e.target.closest('.video-container').classList.add('dragover'); });
      elements.dropArea.addEventListener('dragleave', (e) => e.target.closest('.video-container').classList.remove('dragleave'));
      elements.dropArea.addEventListener('drop', (e) => { e.preventDefault(); e.target.closest('.video-container').classList.remove('dragover'); e.dataTransfer.files.length && handleFileSelect(e.dataTransfer.files[0]); });
      elements.analyzeFileBtn.addEventListener('click', analyzeUploadedVideo);
      if (elements.analyzeUrlBtn) elements.analyzeUrlBtn.addEventListener('click', () => { if (state.isYouTubeStreaming) { stopYouTubeStream(); } else { startYouTubeStream(); } });
      elements.analyzeUrlOfflineBtn.addEventListener('click', analyzeYouTubeOffline);
      elements.alertThresholdSlider.addEventListener('input', (e) => { state.settings.alertThreshold = parseInt(e.target.value); elements.thresholdValue.textContent = e.target.value; });
      elements.themeDarkBtn.addEventListener('click', () => { elements.body.classList.remove('light-theme'); createMainChart(); });
      elements.themeLightBtn.addEventListener('click', () => { elements.body.classList.add('light-theme'); createMainChart(); });
      elements.applyFiltersBtn.addEventListener('click', () => { const severity = elements.filterSeverity.value; const startDate = elements.filterDateStart.valueAsDate; const endDate = elements.filterDateEnd.valueAsDate; if(endDate) endDate.setHours(23, 59, 59, 999); const filtered = state.allAlerts.filter(alert => { const sevMatch = (severity === 'all' || alert.type === severity); const startMatch = (!startDate || alert.timestamp >= startDate); const endMatch = (!endDate || alert.timestamp <= endDate); return sevMatch && startMatch && endMatch; }); renderAlertsLog(filtered); });
      elements.historyLogBody.addEventListener('click', (e) => { const downloadButton = e.target.closest('button[data-action="download"]'); if (downloadButton) { const eventId = parseInt(downloadButton.dataset.eventId); const event = state.eventHistory.find(ev => ev.id === eventId); if (event && event.clipBlob) { downloadClip(event.clipBlob, `Avertix_Event_${event.id}_${new Date(event.timestamp).toISOString()}.webm`); } } });
      elements.clearHistoryBtn.addEventListener('click', clearHistory);
      elements.historySearch.addEventListener('input', renderHistoryLog);
      elements.alertsContainer.addEventListener('click', (e) => {
        const alertCard = e.target.closest('.alert-card[data-video-time]');
        if (alertCard && state.activeDashboardMode === 'offline') {
            const timeInSeconds = parseFloat(alertCard.dataset.videoTime);
            if (!isNaN(timeInSeconds) && elements.offlineVideo.src && elements.offlineVideo.readyState > 0) {
                elements.offlineVideo.currentTime = timeInSeconds;
                elements.offlineVideo.play();
                showAlert(`Jumped to ${new Date(timeInSeconds * 1000).toISOString().substr(14, 5)} from alert.`, 'info');
            } else {
                showAlert('Cannot sync. Is the correct offline video loaded?', 'warning');
            }
        }
      });
      elements.videoSidebarToggle.addEventListener('click', () => toggleVideoSidebar());
      elements.openSidebarLink.addEventListener('click', (e) => { e.preventDefault(); toggleVideoSidebar(true); });
      elements.preselectedVideosList.addEventListener('click', (e) => {
          const item = e.target.closest('.video-list-item[data-index]');
          if (item) loadPreselectedVideo(parseInt(item.dataset.index));
      });
      elements.offlineVideo.addEventListener('play', () => { if(state.activeDashboardMode === 'offline') requestAnimationFrame(animateOfflineChart); });
      elements.offlineVideo.addEventListener('pause', () => cancelAnimationFrame(offlineChartAnimationId));
      elements.offlineVideo.addEventListener('ended', () => {
          cancelAnimationFrame(offlineChartAnimationId);
          if (offlineAnalysisData) { mainChart.data.datasets[0].data = offlineAnalysisData; mainChart.update('none'); }
      });

      // --- INITIALIZATION ---
      const init = () => { 
        switchView('dashboard-view'); 
        createMainChart(); 
        populatePreselectedVideos();
        toggleVideoSidebar(false);
        showAlert("Welcome to Avertix. Systems online and API connected.", "info"); 
      };
      
      // --- AUTHENTICATION JAVASCRIPT ---
      // Authentication elements
      const authContainer = document.getElementById('auth-container');
      const mainApplication = document.getElementById('main-application');
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const authLoading = document.getElementById('auth-loading');
      const loginFormElement = document.getElementById('login-form-element');
      const registerFormElement = document.getElementById('register-form-element');
      const showRegisterBtn = document.getElementById('show-register');
      const showLoginBtn = document.getElementById('show-login');
      const authThemeDarkBtn = document.getElementById('auth-theme-dark-btn');
      const authThemeLightBtn = document.getElementById('auth-theme-light-btn');
      const logoutBtn = document.getElementById('logout-btn');

      // Show/hide authentication forms
      function showAuthForm(formType) {
        loginForm.classList.toggle('active-form', formType === 'login');
        registerForm.classList.toggle('active-form', formType === 'register');
        authLoading.classList.remove('active-form');
      }

      function showAuthLoading() {
        loginForm.classList.remove('active-form');
        registerForm.classList.remove('active-form');
        authLoading.classList.add('active-form');
      }

      // Check authentication status
      async function checkAuthenticationStatus() {
        try {
          const response = await fetch('/auth/status');
          const data = await response.json();
          
          if (data.authenticated) {
            // User is authenticated, show main app
            authContainer.style.display = 'none';
            mainApplication.style.display = 'flex';
            updateUserInfo(data.user);
            init(); // Initialize the main app
          } else {
            // User not authenticated, show login
            authContainer.style.display = 'flex';
            mainApplication.style.display = 'none';
          }
        } catch (error) {
          console.error('Auth status check failed:', error);
          authContainer.style.display = 'flex';
          mainApplication.style.display = 'none';
        }
      }

      // Update user info in the interface
      function updateUserInfo(user) {
        const usernameInput = document.getElementById('current-username');
        const lastLoginInput = document.getElementById('current-last-login');
        
        if (usernameInput) {
          usernameInput.value = user.username;
        }
        
        if (lastLoginInput && user.last_login) {
          const lastLogin = new Date(user.last_login).toLocaleString();
          lastLoginInput.value = lastLogin;
        } else if (lastLoginInput) {
          lastLoginInput.value = 'First login';
        }
      }

      // Handle logout
      async function handleLogout() {
        try {
          const response = await fetch('/auth/logout', {
            method: 'POST'
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Logout successful, show auth screen
            authContainer.style.display = 'flex';
            mainApplication.style.display = 'none';
            showAuthForm('login');
            
            // Clear any user data
            document.getElementById('current-username').value = '';
            document.getElementById('current-last-login').value = '';
          } else {
            showAlert('Logout failed. Please try again.', 'warning');
          }
        } catch (error) {
          showAlert('Network error during logout.', 'warning');
        }
      }

      // Handle login
      async function handleLogin(event) {
        event.preventDefault();
        showAuthLoading();
        
        const formData = new FormData(event.target);
        const username = formData.get('username');
        const password = formData.get('password');
        
        if (!username || !password) {
          showAuthError('Please fill in all fields');
          showAuthForm('login');
          return;
        }
        
        try {
          const response = await fetch('/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username, password })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Login successful
            authContainer.style.display = 'none';
            mainApplication.style.display = 'flex';
            updateUserInfo(data.user);
            init(); // Initialize the main app
          } else {
            showAuthError(data.message || 'Login failed');
            showAuthForm('login');
          }
        } catch (error) {
          showAuthError('Network error. Please try again.');
          showAuthForm('login');
        }
      }

      // Handle registration
      async function handleRegister(event) {
        event.preventDefault();
        showAuthLoading();
        
        const formData = new FormData(event.target);
        const username = formData.get('username');
        const password = formData.get('password');
        const confirmPassword = formData.get('confirmPassword');
        
        if (!username || !password || !confirmPassword) {
          showAuthError('Please fill in all fields');
          showAuthForm('register');
          return;
        }
        
        if (password !== confirmPassword) {
          showAuthError('Passwords do not match');
          showAuthForm('register');
          return;
        }
        
        if (password.length < 6) {
          showAuthError('Password must be at least 6 characters long');
          showAuthForm('register');
          return;
        }
        
        try {
          const response = await fetch('/auth/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username, password })
          });
          
          const data = await response.json();
          
          if (data.success) {
            showAuthSuccess('Account created successfully! Please sign in.');
            showAuthForm('login');
            // Clear the registration form
            registerFormElement.reset();
          } else {
            showAuthError(data.message || 'Registration failed');
            showAuthForm('register');
          }
        } catch (error) {
          showAuthError('Network error. Please try again.');
          showAuthForm('register');
        }
      }

      // Show authentication messages
      function showAuthError(message) {
        const existing = document.querySelector('.auth-message');
        if (existing) existing.remove();
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'auth-message auth-error';
        messageDiv.textContent = message;
        
        const authCard = document.querySelector('.auth-card');
        authCard.insertBefore(messageDiv, authCard.firstChild);
        
        setTimeout(() => messageDiv.remove(), 5000);
      }

      function showAuthSuccess(message) {
        const existing = document.querySelector('.auth-message');
        if (existing) existing.remove();
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'auth-message auth-success';
        messageDiv.textContent = message;
        
        const authCard = document.querySelector('.auth-card');
        authCard.insertBefore(messageDiv, authCard.firstChild);
        
        setTimeout(() => messageDiv.remove(), 5000);
      }

      // Event listeners for authentication
      loginFormElement.addEventListener('submit', handleLogin);
      registerFormElement.addEventListener('submit', handleRegister);
      showRegisterBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showAuthForm('register');
      });
      showLoginBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showAuthForm('login');
      });
      if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
      }

      // Authentication theme toggle
      authThemeDarkBtn.addEventListener('click', () => {
        document.body.classList.remove('light-theme');
        authThemeDarkBtn.classList.add('active-theme');
        authThemeLightBtn.classList.remove('active-theme');
      });
      authThemeLightBtn.addEventListener('click', () => {
        document.body.classList.add('light-theme');
        authThemeLightBtn.classList.add('active-theme');
        authThemeDarkBtn.classList.remove('active-theme');
      });
      
      // Check authentication on page load to kick things off
      checkAuthenticationStatus();

    });
  </script>
</body>
</html>